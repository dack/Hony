<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BATTLE-BOY</title>
    
    <!-- Add favicon and app icons -->
    <link rel="icon" href="https://i.ibb.co/YTKfRRSr/IMG-20260121-WA0225.jpg" type="image/jpg">
    <link rel="apple-touch-icon" href="https://i.ibb.co/YTKfRRSr/IMG-20260121-WA0225.jpg">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <style>
        :root {
            --bg-primary: #05051E;
            --bg-secondary: #141432;
            --bg-tertiary: #1F1F40;
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0B8;
            --accent-cyan: #00E0FF;
            --accent-pink: #FF3D71;
            --border-color: #2a2a4a;
            --btn-green: #4CAF50;
            --btn-orange: #FF9800;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary); 
            padding-top: 80px; 
            padding-bottom: 100px; 
            overflow-x: hidden; 
        }
        
        /* === ANIMATIONS === */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-enter { animation: fadeUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .section { display: none; opacity: 0; } 
        .section.active { display: block; animation: fadeUp 0.4s ease-out forwards; } 
        button:active, .category-card:active, .game-card:active, .menu-item:active, .btn-action:active, .support-card:active { transform: scale(0.95); transition: transform 0.1s; }

        /* === HEADER === */
        .app-header { 
            position: fixed; top: 0; left: 0; width: 100%; height: 75px; 
            background-color: var(--bg-primary); 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 1.2rem; z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .user-info { display: flex; align-items: center; gap: 0.75rem; }
        .user-avatar { 
            width: 50px; height: 50px; border-radius: 50%; 
            background-color: var(--accent-cyan); color: var(--bg-primary); 
            display: flex; justify-content: center; align-items: center; 
            font-weight: 700; font-size: 1.2rem; text-transform: uppercase; 
            box-shadow: 0 0 10px rgba(0, 224, 255, 0.3);
        }
        .welcome-text h2 { font-size: 0.9rem; color: var(--text-secondary); margin: 0; font-weight: 400; }
        .welcome-text p { font-size: 1.1rem; color: var(--text-primary); margin: 0; font-weight: 600; }
        
        .wallet-button { 
            display: flex; align-items: center; gap: 0.6rem; 
            background-color: rgba(255,255,255,0.05); 
            border: 1px solid rgba(0, 224, 255, 0.3);
            padding: 0.4rem 0.5rem 0.4rem 1rem; border-radius: 50px; 
            text-decoration: none; color: white; transition: all 0.3s;
        }
        .wallet-text { font-weight: 600; font-size: 1rem; }
        .wallet-plus { 
            background-color: var(--accent-cyan); color: var(--bg-primary); 
            border-radius: 50%; width: 24px; height: 24px; 
            display: inline-flex; justify-content: center; align-items: center; 
            font-weight: bold; font-size: 1rem;
        }

        /* === WALLET & WITHDRAW STYLES === */
        .wallet-card {
            background: linear-gradient(135deg, #7F00FF, #00C6FF);
            border-radius: 20px; padding: 25px 20px; color: white; margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(0, 100, 255, 0.3); position: relative; overflow: hidden;
        }
        .wallet-card::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none; }
        .wallet-label { font-size: 0.8rem; text-transform: uppercase; opacity: 0.8; letter-spacing: 0.5px; margin-bottom: 5px; }
        .wallet-balance { font-size: 2.5rem; font-weight: 700; margin-bottom: 15px; line-height: 1.1; }
        .wallet-divider { height: 1px; background-color: rgba(255,255,255,0.2); margin-bottom: 15px; }
        .wallet-details { display: flex; justify-content: space-between; }
        .wallet-sub-value { font-size: 1.2rem; font-weight: 600; }
        .wallet-actions { display: flex; gap: 15px; margin-bottom: 30px; }
        .btn-action { flex: 1; border: none; border-radius: 12px; padding: 14px; font-weight: 600; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.95rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
        .btn-add { background-color: var(--btn-green); }
        .btn-withdraw { background-color: var(--btn-orange); }

        /* === ADD MONEY PAGE SPECIFIC STYLES === */
        .am-input-group { 
            background-color: var(--bg-secondary); 
            border: 1px solid var(--border-color); 
            border-radius: 12px; 
            display: flex; align-items: center; 
            padding: 15px; margin-bottom: 25px; 
        }
        .am-currency-symbol { 
            font-size: 1.5rem; color: var(--accent-cyan); 
            font-weight: 600; margin-right: 15px; 
        }
        .am-input { 
            background: transparent; border: none; color: white; 
            width: 100%; font-size: 1.1rem; outline: none; 
        }
        .am-input::placeholder { color: #6c757d; font-size: 1rem; }
        
        .btn-cyan-block { 
            width: 100%; background-color: var(--accent-cyan); color: #000; 
            font-weight: 700; padding: 16px; border-radius: 12px; border: none; 
            font-size: 1.1rem; margin-bottom: 30px; cursor: pointer;
        }
        
        .instruction-card { 
            background-color: var(--bg-secondary); border-radius: 16px; 
            padding: 20px; border: 1px solid var(--border-color); 
        }
        .instruction-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; color: white; }
        .instruction-item { display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-start; }
        .instruction-item:last-child { margin-bottom: 0; }
        .instruction-icon { 
            font-size: 1.2rem; color: var(--accent-cyan); 
            width: 25px; text-align: center; flex-shrink: 0; margin-top: 2px; 
        }
        .instruction-text { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5; }

        /* === PREPARING PAGE STYLES === */
        .preparing-container { height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .countdown-circle {
            position: relative; width: 120px; height: 120px; margin-bottom: 40px;
            display: flex; justify-content: center; align-items: center;
        }
        .countdown-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .countdown-circle-bg { fill: none; stroke: var(--bg-secondary); stroke-width: 8; }
        .countdown-circle-progress { 
            fill: none; stroke: var(--accent-cyan); stroke-width: 8; stroke-linecap: round;
            stroke-dasharray: 283; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear;
        }
        .countdown-number { font-size: 3rem; font-weight: 700; color: white; z-index: 10; }
        .countdown-ripple {
            position: absolute; width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid var(--accent-cyan); animation: ripple 1.5s infinite; opacity: 0;
        }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.5); opacity: 0; } }

        /* === PAYMENT QR PAGE STYLES === */
        .payment-qr-card {
            background-color: #000; border-radius: 20px; padding: 20px; margin-top: 20px;
            border: 1px solid #333; position: relative;
        }
        .close-qr-btn {
            position: absolute; top: -10px; right: -10px; width: 30px; height: 30px;
            background-color: #ff3d3d; color: white; border-radius: 50%; border: none;
            display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 14px; z-index: 10;
        }
        .pay-header { display: flex; gap: 15px; align-items: center; margin-bottom: 25px; background: #1a1a1a; padding: 10px; border-radius: 10px; }
        .upi-logo-box { width: 60px; height: 60px; background: white; border-radius: 8px; display: flex; justify-content: center; align-items: center; padding: 5px; }
        .upi-logo-box img { width: 100%; object-fit: contain; }
        .pay-info h4 { margin: 0; font-size: 1.1rem; color: white; font-weight: 700; }
        .pay-info span { font-size: 0.8rem; color: #ffbf00; display: flex; align-items: center; gap: 5px; }
        .qr-container { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .qr-image { width: 100%; max-width: 250px; display: block; margin: 0 auto; }
        .qr-timer { color: #ffbf00; font-weight: 600; text-align: center; margin-bottom: 10px; font-size: 0.95rem; }
        
        .payment-loader { display: flex; justify-content: center; gap: 5px; margin-bottom: 20px; }
        .payment-loader span {
            width: 25px; height: 4px; background-color: #333; border-radius: 2px;
            animation: loaderBar 1.5s infinite ease-in-out;
        }
        .payment-loader span:nth-child(1) { animation-delay: 0.0s; }
        .payment-loader span:nth-child(2) { animation-delay: 0.2s; }
        .payment-loader span:nth-child(3) { animation-delay: 0.4s; }
        .payment-loader span:nth-child(4) { animation-delay: 0.6s; }
        .payment-loader span:nth-child(5) { animation-delay: 0.8s; }
        @keyframes loaderBar { 0%, 100% { background-color: #333; } 50% { background-color: white; } }

        .btn-paytm { background: white; color: black; width: 100%; padding: 12px; border-radius: 8px; font-weight: 700; border: none; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-download-qr { background: transparent; border: 1px solid var(--accent-cyan); color: white; width: 100%; padding: 12px; border-radius: 8px; font-weight: 600; }
        .payment-details-footer { margin-top: 25px; padding-top: 15px; border-top: 1px solid #333; }
        .detail-row { display: flex; justify-content: space-between; font-size: 0.95rem; margin-bottom: 8px; }
        .detail-row span:first-child { color: var(--text-secondary); }
        .detail-row span:last-child { color: white; font-weight: 600; font-family: monospace; }
        
        /* NEW: Payment Verification Styles */
        .btn-verify-payment { width: 100%; background-color: #28a745; color: white; padding: 12px; border-radius: 8px; font-weight: 700; border: none; margin-top: 15px; text-transform: uppercase; letter-spacing: 0.5px; }
        .verification-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .verification-card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 20px; padding: 25px; width: 100%; max-width: 350px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: popIn 0.3s; }
        .verification-card h4 { color: white; font-weight: 600; margin-bottom: 20px; text-align: center; }
        .verification-card label { color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 8px; display: block; }

        /* === REFERRAL PAGE STYLES === */
        .referral-card-main { background-color: var(--bg-secondary); border-radius: 16px; padding: 25px 20px; text-align: center; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .referral-title { font-size: 0.8rem; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 15px; text-transform: uppercase; }
        .referral-code-box { border: 2px solid var(--accent-cyan); border-radius: 50px; padding: 10px 30px; display: inline-block; font-size: 1.6rem; font-weight: 700; color: white; margin-bottom: 25px; background: rgba(0, 224, 255, 0.05); }
        .referral-actions { display: flex; gap: 15px; justify-content: center; }
        .btn-ref-copy { background: transparent; border: 1px solid var(--accent-cyan); color: var(--accent-cyan); border-radius: 50px; padding: 10px 25px; font-weight: 600; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-ref-share { background: var(--accent-cyan); border: none; color: var(--bg-primary); border-radius: 50px; padding: 10px 25px; font-weight: 700; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .referral-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .ref-stat-card { background-color: var(--bg-secondary); border-radius: 16px; padding: 20px 10px; text-align: center; border: 1px solid #252545; }
        .ref-stat-val { font-size: 1.4rem; font-weight: 700; color: var(--accent-cyan); display: block; margin-bottom: 5px; }
        .ref-stat-label { font-size: 0.8rem; color: var(--text-secondary); }
        .recent-ref-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 15px; }
        .empty-ref-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }

        /* === CUSTOMER SUPPORT GRID STYLES === */
        .support-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 10px; margin-top: 10px; }
        .support-card {
            background-color: #151530; border-radius: 16px; padding: 25px 15px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; cursor: pointer; border: 1px solid #2a2a4a;
            height: 160px; transition: transform 0.2s;
        }
        .support-card:hover { border-color: var(--accent-cyan); }
        .support-icon { font-size: 2.8rem; margin-bottom: 15px; }
        .support-name { font-size: 1rem; font-weight: 500; color: white; }
        .icon-whatsapp { color: #25D366; } .icon-telegram { color: #0088cc; } .icon-instagram { color: #E1306C; } .icon-youtube { color: #FF0000; } .icon-email { color: #FFB300; } .icon-website { color: #5C5CFF; }

        /* === WITHDRAW PAGE STYLES === */
        .withdraw-balance-card { background-color: #1C1C3A; border-radius: 16px; padding: 20px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #2a2a4a; }
        .wb-left { display: flex; align-items: center; gap: 10px; color: var(--text-secondary); font-size: 0.9rem; }
        .wb-icon { color: var(--accent-cyan); font-size: 1.2rem; }
        .wb-amount { font-size: 1.2rem; font-weight: 600; color: white; }
        .custom-input { background-color: #151530; border: 1px solid #2a2a4a; color: white; padding: 15px; border-radius: 12px; font-size: 1rem; width: 100%; }
        .custom-input::placeholder { color: #565676; }
        .custom-input:focus { background-color: #151530; border-color: var(--accent-cyan); box-shadow: none; color: white; }

        /* Profile Styles */
        .profile-new-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .profile-new-avatar { width: 70px; height: 70px; border-radius: 50%; background-color: var(--accent-cyan); color: var(--bg-primary); display: flex; justify-content: center; align-items: center; font-size: 1.8rem; font-weight: 700; text-transform: uppercase; }
        .profile-new-info h3 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .profile-new-info p { margin: 0; color: var(--text-secondary); font-size: 0.9rem; }
        .profile-edit-btn i { color: var(--text-secondary); font-size: 1.2rem; }
        .profile-stats-card { background-color: var(--bg-secondary); border-radius: 16px; padding: 20px; margin-bottom: 25px; display: flex; justify-content: space-between; text-align: center; }
        .p-stat-item { flex: 1; }
        .p-stat-icon { font-size: 1.5rem; color: var(--accent-cyan); margin-bottom: 5px; }
        .p-stat-val { display: block; font-size: 1.2rem; font-weight: 600; color: white; line-height: 1.2; }
        .p-stat-label { font-size: 0.75rem; color: var(--text-secondary); }
        .profile-menu-card { background-color: var(--bg-secondary); border-radius: 16px; padding: 10px 0; overflow: hidden; }
        .p-menu-item { display: flex; align-items: center; padding: 15px 20px; text-decoration: none; color: white; transition: background 0.2s; }
        .p-menu-item:active { background-color: rgba(255,255,255,0.05); }
        .p-menu-icon { width: 30px; font-size: 1.1rem; color: var(--text-secondary); }
        .p-menu-text { flex-grow: 1; font-size: 0.95rem; font-weight: 500; }
        .p-menu-arrow { color: var(--text-secondary); font-size: 0.8rem; }
        .menu-divider { height: 1px; background-color: var(--border-color); margin: 5px 20px; }
        .text-cyan { color: var(--accent-cyan) !important; }
        .text-red { color: var(--accent-pink) !important; }

        /* AI Chat Styles - IMPROVED */
        .chat-layout { 
            height: calc(100vh - 160px); 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background: var(--bg-primary);
        }
        .chat-messages-container { 
            flex-grow: 1; 
            overflow-y: auto; 
            padding: 20px 15px 90px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            scroll-behavior: smooth;
        }
        .message-row { 
            display: flex; 
            align-items: flex-start; 
            gap: 10px; 
            max-width: 100%; 
            animation: fadeUp 0.3s ease-out;
        }
        .message-row.user { 
            flex-direction: row-reverse; 
        }
        .chat-bot-avatar { 
            width: 36px; 
            height: 36px; 
            background: linear-gradient(135deg, var(--accent-cyan), #00b4d8); 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: black; 
            font-size: 0.9rem; 
            flex-shrink: 0; 
            box-shadow: 0 4px 10px rgba(0, 224, 255, 0.3);
        }
        .chat-bubble { 
            max-width: 78%; 
            padding: 12px 16px; 
            border-radius: 18px; 
            font-size: 0.95rem; 
            line-height: 1.5; 
            position: relative; 
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chat-bubble.bot { 
            background-color: var(--bg-tertiary); 
            color: white; 
            border-bottom-left-radius: 4px; 
            border: 1px solid rgba(255,255,255,0.05);
        }
        .chat-bubble.user { 
            background: linear-gradient(135deg, var(--accent-cyan), #00b4d8); 
            color: black; 
            border-bottom-right-radius: 4px; 
            font-weight: 500;
        }
        .chat-input-area { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background-color: var(--bg-primary); 
            border-top: 1px solid var(--border-color); 
            padding: 12px 15px 20px; 
            z-index: 1002; 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            box-shadow: 0 -5px 20px rgba(0,0,0,0.3);
        }
        .chat-input-field { 
            flex-grow: 1; 
            background-color: var(--bg-secondary); 
            border: 2px solid transparent; 
            color: white; 
            padding: 12px 18px; 
            border-radius: 25px; 
            outline: none; 
            font-size: 1rem; 
            transition: all 0.3s;
        }
        .chat-input-field:focus { 
            border-color: var(--accent-cyan); 
            box-shadow: 0 0 0 3px rgba(0, 224, 255, 0.1);
        }
        .chat-send-btn { 
            width: 50px; 
            height: 50px; 
            background: linear-gradient(135deg, var(--accent-cyan), #00b4d8); 
            border-radius: 50%; 
            border: none; 
            color: var(--bg-primary); 
            font-size: 1.2rem; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 224, 255, 0.3);
        }
        .chat-send-btn:active {
            transform: scale(0.95);
        }
        .chat-typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 18px;
            width: fit-content;
            margin-bottom: 4px;
        }
        .chat-typing-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-cyan);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        .chat-typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .chat-typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }

        /* === HOME & OTHER STYLES === */
        .swiper { 
            width: 94%;
            margin: 0 auto 1.5rem auto;
            border-radius: 16px; 
            background-color: var(--bg-secondary); 
            aspect-ratio: 2 / 1;
            overflow: hidden; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .swiper-slide img { display: block; width: 100%; height: 100%; object-fit: cover; }
        .swiper-pagination-bullet-active { background-color: var(--accent-cyan) !important; width: 20px; border-radius: 4px; }
        
        .section-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .contest-categories { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 15px; 
            margin-bottom: 2rem; 
            padding: 0 5px;
        }
        .category-card { 
            background-color: #171738; 
            border-radius: 22px; 
            padding: 25px 10px; 
            text-align: center; 
            cursor: pointer; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            transition: transform 0.2s;
        }
        .category-card .icon-circle { 
            width: 50px; height: 50px; 
            border-radius: 50%; 
            border: 2px solid var(--accent-pink); 
            display: flex; justify-content: center; align-items: center; 
            margin: 0 auto 10px auto; 
            color: var(--accent-pink); 
            font-size: 1.2rem; 
            background: rgba(255, 61, 113, 0.1); 
        }
        .category-card span { 
            display: block; 
            font-size: 0.8rem; 
            font-weight: 600; 
            color: #fff; 
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .game-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding-bottom: 1rem; padding-left: 5px; padding-right: 5px; }
        .game-card { 
            width: 100%; 
            border-radius: 18px; 
            overflow: hidden; 
            cursor: pointer; 
            text-align: center; 
            background-color: #11112b;
            padding-bottom: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .game-card:active { transform: scale(0.98); }
        .game-card img { 
            width: 100%; 
            aspect-ratio: 1/1; 
            object-fit: cover; 
            border-radius: 18px;
            margin-bottom: 8px;
            display: block;
        }
        .game-card .game-title { 
            font-size: 0.75rem; 
            color: #A0A0B8; 
            font-weight: 700; 
            text-transform: uppercase; 
            padding: 0 5px;
        }

        .privacy-content h2 { font-size: 1.5rem; margin-bottom: 0.5rem; color: white; }
        .privacy-content h4 { color: white; margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.1rem; }
        .privacy-content p { color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; margin-bottom: 1rem; }
        .privacy-content ul { padding-left: 20px; color: var(--text-secondary); margin-bottom: 1rem; }
        .privacy-content li { margin-bottom: 10px; font-size: 0.9rem; line-height: 1.6; }
        .privacy-content strong { color: white; font-weight: 600; }

        .tournament-card { 
            background-color: #151530;
            border-radius: 16px; 
            overflow: hidden; 
            margin-bottom: 20px; 
            border: 1px solid #2a2a4a;
            padding: 0;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .tournament-card:active { transform: scale(0.98); }
        .t-banner-img {
            width: 100%;
            height: auto;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            display: block;
        }
        .t-content-body {
            padding: 15px;
        }
        .t-header-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .t-title-text {
            font-size: 1rem;
            font-weight: 600;
            color: white;
            margin: 0;
            line-height: 1.2;
        }
        .t-date-row {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #A0A0B8;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }
        .t-stats-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .t-stat-box {
            text-align: center;
        }
        .t-stat-label {
            display: block;
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #7d7d9e;
            margin-bottom: 2px;
            letter-spacing: 0.5px;
        }
        .t-stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-cyan);
        }
        .t-progress-area {
            margin-bottom: 5px;
        }
        .t-progress-track {
            width: 100%;
            height: 6px;
            background-color: #2a2a4a;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 6px;
        }
        .t-progress-bar {
            height: 100%;
            background-color: var(--accent-cyan);
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }
        .t-slots-text {
            font-size: 0.75rem;
            color: #7d7d9e;
        }
        
        .tournament-tabs { 
            display: flex; 
            justify-content: space-around; 
            background-color: transparent; 
            padding: 0; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #2a2a4a;
        } 
        .tab-item { 
            color: var(--text-secondary); 
            background: none; 
            border: none; 
            padding: 10px 15px; 
            font-weight: 500; 
            font-size: 0.9rem;
            position: relative;
            cursor: pointer; 
            text-transform: uppercase;
        } 
        .tab-item.active { 
            color: white; 
            font-weight: 600;
        }
        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--accent-cyan);
            border-radius: 3px 3px 0 0;
        }

        .bottom-nav-container { position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; z-index: 1000; pointer-events: none; }
        .bottom-nav-bar { pointer-events: auto; position: absolute; bottom: 0; left: 0; width: 100%; height: 65px; background-color: #12122b; display: flex; justify-content: space-around; align-items: center; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.5); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #565676; background: none; border: none; height: 100%; cursor: pointer; }
        .nav-item.active { color: white; } .nav-item.active i { color: var(--accent-cyan); }
        .nav-item i { font-size: 1.8rem; margin-bottom: 2px; }
        
        .nav-fab-wrapper { pointer-events: auto; position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 75px; height: 75px; background-color: var(--bg-primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 1002; padding: 8px; }
        .nav-fab { width: 100%; height: 100%; background: linear-gradient(135deg, #1e1e40, #0a0a1a); border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.6); color: #fff; font-size: 2rem; border: 2px solid #2a2a4a; cursor: pointer; }
        .nav-fab.active { color: var(--accent-cyan); border-color: var(--accent-cyan); box-shadow: 0 0 20px rgba(0, 224, 255, 0.4); transform: translateY(-5px); }
        
        #globalLoaderEl { background: var(--bg-primary); display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; justify-content: center; align-items: center; }
        .fancy-spinner { width: 4rem; height: 4rem; border-radius: 50%; border: 4px solid var(--bg-secondary); border-top-color: var(--accent-cyan); animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .custom-card { background-color: var(--bg-secondary); border-radius: 16px; border: none; }
        .form-control { background-color: #0d0d26; border: 1px solid #2a2a4a; color: white; border-radius: 10px; padding: 14px; }

        .md-container {
            background-color: var(--bg-primary);
            min-height: 100vh;
            padding-bottom: 90px;
            position: relative;
            z-index: 2000;
        }

        .md-header-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; align-items: center; padding: 0 15px;
            z-index: 10;
            background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
        }
        .md-back-btn { color: white; font-size: 1.5rem; background: none; border: none; }
        .md-banner {
            width: 100%; height: 260px; object-fit: cover;
            mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 80%, rgba(0,0,0,0));
            -webkit-mask-image: linear-gradient(to bottom, rgba(0,0,0,1) 80%, rgba(0,0,0,0));
        }
        .md-title-overlay {
            margin-top: -60px; padding: 0 20px; position: relative; z-index: 5;
            text-align: center;
        }
        .md-game-logo { width: 100%; max-width: 250px; margin-bottom: 5px; filter: drop-shadow(0 0 10px rgba(0,0,0,0.8)); }
        .md-match-title { font-size: 1.4rem; font-weight: 700; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        .md-meta-grid {
            display: flex; justify-content: space-around;
            padding: 10px 15px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .md-meta-item { text-align: center; }
        .md-meta-label { font-size: 0.7rem; color: #7d7d9e; text-transform: uppercase; margin-bottom: 2px; }
        .md-meta-val { font-size: 0.95rem; color: white; font-weight: 600; display: flex; align-items: center; gap: 5px; justify-content: center; }

        .md-time-card {
            background: #141432; border-radius: 12px; margin: 15px; padding: 12px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            border: 1px solid #2a2a4a; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .md-time-text { color: white; font-weight: 500; font-size: 0.95rem; }
        .md-time-icon { color: var(--accent-cyan); }

        .md-stats-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;
            padding: 0 15px; margin-bottom: 15px;
        }
        .md-stat-card {
            background: #151530; border-radius: 12px; padding: 15px 5px;
            text-align: center; border: 1px solid #2a2a4a;
        }
        .md-stat-card h5 { color: #7d7d9e; font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase; }
        .md-stat-card span { font-size: 1.1rem; font-weight: 700; color: var(--accent-cyan); }

        .md-room-card {
            background: #151530; border-radius: 12px; margin: 0 15px 20px 15px;
            border: 1px solid #2a2a4a; display: flex; overflow: hidden;
        }
        .md-room-col { flex: 1; padding: 15px; text-align: center; border-right: 1px solid #2a2a4a; }
        .md-room-col:last-child { border-right: none; }
        .md-room-label { font-size: 0.65rem; color: #7d7d9e; margin-bottom: 5px; text-transform: uppercase; }
        .md-room-val { font-size: 1rem; color: #565676; font-weight: 600; letter-spacing: 0.5px; }

        .md-tabs { display: flex; border-bottom: 1px solid #2a2a4a; margin-bottom: 15px; }
        .md-tab {
            flex: 1; text-align: center; padding: 12px;
            background: none; border: none; color: #7d7d9e;
            font-size: 0.85rem; font-weight: 600; letter-spacing: 1px;
            position: relative;
        }
        .md-tab.active { color: var(--accent-pink); }
        .md-tab.active::after {
            content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 40px; height: 3px; background-color: var(--accent-pink); border-radius: 3px 3px 0 0;
        }

        .md-content-box { padding: 0 20px; }
        .md-section-title { font-size: 1rem; color: white; font-weight: 600; margin-bottom: 10px; text-transform: uppercase; }
        .md-text-block { color: #A0A0B8; font-size: 0.85rem; line-height: 1.6; margin-bottom: 20px; }
        .md-text-block ul { padding-left: 20px; margin-top: 5px; }
        .md-text-block li { margin-bottom: 8px; }

        .md-fixed-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #05051E; padding: 15px 20px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5); z-index: 2001;
            border-top: 1px solid #2a2a4a;
        }
        .btn-join-match {
            width: 100%; background: linear-gradient(90deg, #FF3D71, #A0153E);
            color: white; border: none; border-radius: 50px; padding: 14px;
            font-size: 1.1rem; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(255, 61, 113, 0.4);
            cursor: pointer;
        }

        .slot-list-header { display: flex; justify-content: space-between; padding: 15px 20px; background-color: #0d0d26; color: #A0A0B8; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .slot-list-scroll { 
            height: calc(100vh - 140px);
            overflow-y: auto; 
            padding-bottom: 120px;
        }
        .slot-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #1F1F40; cursor: pointer; }
        .slot-number { color: white; font-weight: 600; }
        .slot-checkbox { width: 24px; height: 24px; border: 2px solid #565676; border-radius: 4px; display: flex; justify-content: center; align-items: center; transition: all 0.2s; }
        .slot-row.active .slot-checkbox { background-color: var(--accent-cyan); border-color: var(--accent-cyan); color: #05051E; }
        .slot-row.active .slot-checkbox::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 14px; }
        .slot-row.disabled { opacity: 0.5; pointer-events: none; }
        .slot-row.disabled .slot-checkbox { background-color: #333; border-color: #333; }
        
        .slot-footer {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background-color: #05051E; border-top: 1px solid #2a2a4a;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; z-index: 2002;
        }
        .slot-footer-info span { display: block; font-size: 0.7rem; color: #7d7d9e; text-transform: uppercase; margin-bottom: 2px; }
        .slot-footer-info strong { display: block; font-size: 1.4rem; color: white; font-weight: 700; }
        .btn-slot-next { background-color: var(--accent-cyan); color: #000; font-weight: 700; padding: 10px 30px; border-radius: 50px; border: none; font-size: 1rem; cursor: pointer; }

        #playerDetailsFormContainer {
            padding-bottom: 160px;
        }
        .details-card { background-color: #151530; border-radius: 12px; padding: 20px; margin: 20px; border: 1px solid #2a2a4a; }
        .details-title { color: white; font-size: 0.95rem; margin-bottom: 20px; font-weight: 600; }
        .details-input-box { margin-bottom: 20px; }
        .details-label { color: #A0A0B8; font-size: 0.8rem; margin-bottom: 8px; display: block; }
        .details-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid #565676; color: white; padding: 8px 0; font-size: 1rem; border-radius: 0; }
        .details-input:focus { outline: none; border-bottom-color: var(--accent-cyan); }
        
        .details-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background-color: #05051E; border-top: 1px solid #2a2a4a;
            padding: 15px 20px; z-index: 2002;
        }
        .details-total-text { font-size: 0.9rem; color: #A0A0B8; margin-bottom: 10px; font-weight: 500; }
        .details-total-text strong { color: white; font-size: 1.1rem; margin-left: 5px; }
        .btn-details-confirm { width: 100%; background-color: #2e2e4d; color: white; font-weight: 700; padding: 14px; border-radius: 50px; border: none; font-size: 1rem; letter-spacing: 0.5px; transition: 0.3s; cursor: pointer; }
        .btn-details-confirm.ready { background-color: var(--btn-green); }

        .btn-view-result {
            width: 100%; background: #FFD700; color: #000;
            border: none; border-radius: 50px; padding: 14px;
            font-size: 1rem; font-weight: 800; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3); margin-top: 10px;
            cursor: pointer;
        }

        .tab-content-area { display: none; padding: 15px 5px; }
        .tab-content-area.active { display: block; animation: fadeUp 0.3s ease; }

        .prize-row { display: flex; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
        .prize-rank { display: flex; align-items: center; gap: 10px; font-weight: 600; color: white; }
        .prize-icon { color: #FFD700; font-size: 1.1rem; }
        .prize-amount { color: var(--accent-cyan); font-weight: 700; }

        .participant-row { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #A0A0B8; display: flex; gap: 15px; }
        .participant-index { width: 25px; color: #565676; font-family: monospace; }
        .participant-name { color: white; font-weight: 500; }

        .result-meta { text-align: center; color: #7d7d9e; font-size: 0.8rem; margin: 15px 0; }
        .full-result-bar {
            background-color: #D32F2F; color: white;
            text-align: center; font-weight: 700; padding: 10px;
            text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem;
        }
        .result-table-header {
            display: grid; grid-template-columns: 0.5fr 3fr 1fr 1fr 1fr;
            background-color: #0091EA; color: white;
            padding: 10px 5px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
        }
        .result-item-row {
            display: grid; grid-template-columns: 0.5fr 3fr 1fr 1fr 1fr;
            padding: 12px 5px; border-bottom: 1px solid #1F1F40;
            align-items: center; background-color: var(--bg-secondary);
        }
        .res-pos { font-weight: 700; color: white; font-size: 0.8rem; }
        .res-name { color: white; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .res-rank-val { color: white; font-weight: 700; text-align: center; font-size: 0.8rem; }
        .res-kill { color: white; text-align: center; font-size: 0.8rem; }
        .res-win { color: #FFD700; font-weight: 700; text-align: right; font-size: 0.8rem; }

        /* AI Assistant Image Upload Styles */
        .chat-image-btn { width: 50px; height: 50px; background-color: var(--bg-secondary); border-radius: 50%; border: 2px solid var(--accent-cyan); color: var(--accent-cyan); font-size: 1.2rem; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; }
        .chat-image-btn:active { transform: scale(0.95); }
        .chat-image-preview { max-width: 150px; border-radius: 10px; margin-top: 5px; border: 2px solid var(--accent-cyan); }
        .image-upload-container { display: flex; align-items: center; gap: 10px; }
        .image-preview-container { position: relative; display: inline-block; }
        .remove-image-btn { position: absolute; top: -8px; right: -8px; background: #ff3d3d; color: white; border-radius: 50%; width: 24px; height: 24px; border: none; font-size: 12px; cursor: pointer; }
        
        /* Notification Settings Styles */
        .notification-settings-card {
            background-color: var(--bg-secondary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        .notification-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .notification-toggle:last-child {
            border-bottom: none;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: var(--accent-cyan);
        }
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        .notification-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #FF3D71;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        /* Room Details Styles for Users */
        .room-details-section {
            background: linear-gradient(135deg, #0a0a1a, #1a1a3a);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 15px;
            border: 1px solid var(--accent-cyan);
            box-shadow: 0 0 20px rgba(0, 224, 255, 0.2);
        }
        .room-details-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .room-details-header i {
            color: var(--accent-cyan);
            font-size: 1.5rem;
        }
        .room-details-header h4 {
            margin: 0;
            color: white;
            font-size: 1.2rem;
        }
        .room-details-body {
            display: grid;
            gap: 15px;
        }
        .room-detail-row {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #2a2a4a;
        }
        .room-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 100px;
        }
        .room-value {
            flex: 1;
            font-family: monospace;
            font-size: 1.1rem;
            color: white;
            padding: 8px 12px;
            background: rgba(0, 224, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(0, 224, 255, 0.3);
        }
        .room-copy-btn {
            background: var(--accent-cyan);
            color: black;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        .room-copy-btn:hover {
            background: #00b4d8;
            transform: translateY(-2px);
        }
        .room-copy-btn:active {
            transform: scale(0.95);
        }
        
        /* Room Details Button Style */
        .btn-room-details {
            width: 100%;
            background: linear-gradient(90deg, #00E0FF, #0091EA);
            color: black;
            border: none;
            border-radius: 50px;
            padding: 14px;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 20px rgba(0, 224, 255, 0.4);
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* Room Details Modal */
        .room-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .room-modal-card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--accent-cyan);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: popIn 0.3s;
        }
        .room-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .room-modal-title {
            color: white;
            font-size: 1.3rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .room-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* App Logo Styles */
        .app-logo {
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid var(--accent-cyan);
            box-shadow: 0 0 15px rgba(0, 224, 255, 0.3);
        }
        
        .app-logo-small {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }
        
        .app-logo-medium {
            width: 80px;
            height: 80px;
            border-radius: 16px;
        }
        
        .app-logo-large {
            width: 120px;
            height: 120px;
            border-radius: 20px;
        }
    </style>
</head>
<body>

    <header class="app-header" id="app-header">
        <div class="header-left d-flex align-items-center gap-3">
            <button class="header-back-button border-0 bg-transparent text-white fs-5" id="headerBackBtn" style="display: none;"><i class="fas fa-arrow-left"></i></button>
            <div class="user-info" id="headerUserInfo">
                <!-- App Icon in Header -->
                <div class="user-avatar" id="headerAvatar">
                    <img src="https://i.ibb.co/YTKfRRSr/IMG-20260121-WA0225.jpg" 
                         alt="App Icon" 
                         style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>
                <div class="welcome-text">
                    <h2 id="headerWelcomeText">Welcome,</h2>
                    <p id="headerUserGreeting">Guest</p>
                </div>
            </div>
            <div class="header-page-title fs-5 fw-bold" id="headerPageTitle" style="display:none;"></div>
        </div>
        
        <a href="#" class="wallet-button" id="headerWalletChip" data-section="wallet-section">
            <span class="wallet-text"> <span id="headerChipBalance">0</span></span>
            <span class="plus-icon wallet-plus">+</span>
        </a>
    </header>

    <main class="main-content">
        <div id="globalLoaderEl"><div class="fancy-spinner"></div></div>
        
        <section id="login-section" class="section"></section>
        <section id="home-section" class="section"></section>
        <section id="profile-section" class="section"></section>
        <section id="wallet-section" class="section"></section>
        <section id="add-money-section" class="section"></section> 
        <section id="withdraw-section" class="section"></section>
        <section id="earn-section" class="section"></section>
        <section id="ai-assistant-section" class="section"></section> 
        <section id="support-section" class="section"></section> 
        <section id="privacy-policy-section" class="section"></section>
        <section id="preparing-payment-section" class="section"></section>
        <section id="payment-qr-section" class="section"></section>
        <section id="history-section" class="section"></section>
        <section id="leaderboard-section" class="section"></section>
        <section id="notifications-section" class="section"></section>
        <section id="tournaments-section" class="section"></section>
        <section id="match-details-section" class="section"></section>
        <section id="match-result-section" class="section"></section>
        
        <!-- NEW SECTIONS -->
        <section id="slot-selection-section" class="section"></section>
        <section id="player-details-section" class="section"></section>
        
        <!-- Room Details Modal -->
        <div id="roomDetailsModal" class="room-modal-overlay" style="display:none;">
            <div class="room-modal-card">
                <div class="room-modal-header">
                    <div class="room-modal-title">
                        <i class="fas fa-door-closed"></i>
                        Room Details
                    </div>
                    <button class="room-modal-close" id="closeRoomModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="room-details-body">
                    <div class="room-detail-row">
                        <div class="room-label">Room ID</div>
                        <div class="room-value" id="modalRoomId">Not set</div>
                        <button class="room-copy-btn" onclick="copyToClipboard('modalRoomId')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                    <div class="room-detail-row">
                        <div class="room-label">Password</div>
                        <div class="room-value" id="modalRoomPass">Not set</div>
                        <button class="room-copy-btn" onclick="copyToClipboard('modalRoomPass')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3" style="background: rgba(0,224,255,0.1); border-color: var(--accent-cyan); color: #A0A0B8;">
                    <i class="fas fa-info-circle"></i>
                    <small>These details are only visible to joined participants. Keep them safe!</small>
                </div>
            </div>
        </div>
    </main>

    <div class="bottom-nav-container" id="bottomNav">
        <div class="nav-fab-wrapper">
            <div class="nav-fab active" data-section="home-section" id="navHomeFab">
                <!-- App Icon in Center Fab -->
                <img src="https://i.ibb.co/YTKfRRSr/IMG-20260121-WA0225.jpg" 
                     alt="App Icon" 
                     style="width: 45px; height: 45px; border-radius: 50%; object-fit: cover;">
            </div>
        </div>
        <nav class="bottom-nav-bar">
            <button class="nav-item" data-section="history-section"><i class="fas fa-gamepad"></i></button>
            <button class="nav-item" data-section="leaderboard-section"><i class="fas fa-chart-bar"></i></button>
            <div class="nav-spacer"></div>
            <button class="nav-item" data-section="wallet-section"><i class="fas fa-wallet"></i></button>
            <button class="nav-item" data-section="profile-section"><i class="fas fa-user"></i></button>
        </nav>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    
    <script type="module">
        // ==========================================
        // CONFIGURATIONS
        // ==========================================
        const ADMIN_UPI_ID = "9229042875@ibl"; 
        const VAPID_KEY = "BOBOinYkBFbVv_nmpoEpFzbl7R_rVe7O_MOWrgatpGOO9fJnkvrJXWPZX_YYaQARapN6-AQ1FYWdK7P1aLD5ADA";
        
        // Updated Support Links
        const SUPPORT_LINKS = {
            whatsapp: "https://wa.me/919229042875",
            telegram: "",
            instagram: "",
            youtube: "",
            email: "",
            website: ""
        };
        
        // App Icon URL (Single source for all icons)
        const APP_ICON_URL = "https://i.ibb.co/YTKfRRSr/IMG-20260121-WA0225.jpg";
        // ==========================================

       const firebaseConfig = {
  apiKey: "AIzaSyDQuNyp6wsubAtq0_5IFmgrklt0qrlob_w",
  authDomain: "battle-boy-7d4b8.firebaseapp.com",
  databaseURL: "https://battle-boy-7d4b8-default-rtdb.firebaseio.com",
  projectId: "battle-boy-7d4b8",
  storageBucket: "battle-boy-7d4b8.firebasestorage.app",
  messagingSenderId: "44275813026",
  appId: "1:44275813026:web:758209b1a5f26495bbe5fb",
  measurementId: "G-90VV8GHQZN"
};

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getDatabase, ref, get, set, push, serverTimestamp, 
            onValue, runTransaction, update, query, orderByChild, 
            equalTo, onChildAdded 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { 
            getAuth, onAuthStateChanged, createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, signOut 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { 
            getStorage, ref as storageRef, uploadBytes, 
            getDownloadURL, deleteObject 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
        // Add Firebase Messaging
        import { 
            getMessaging, getToken, onMessage, isSupported, deleteToken 
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging.js";

        let app, db, auth, storage, messaging;
        try { 
            app = initializeApp(firebaseConfig); 
            db = getDatabase(app); 
            auth = getAuth(app);
            storage = getStorage(app);
        } catch (e) { 
            console.error("Firebase init error:", e);
            throw e; 
        }

        const getElement = (id) => document.getElementById(id);
        const querySel = (sel) => document.querySelector(sel);
        
        let currentUser = null;
        let userProfile = {};
        let chatContext = null; 
        let latestAnnouncement = " No new announcements at the moment.";
        let allTournamentsCache = {};
        let appSettings = {};
        let dbListeners = {};
        let paymentTimerInterval = null;
        let selectedImageFile = null;
        let chatImagePreviewUrl = null;
        let activeSwiper = null;
        let fcmToken = null;
        let notificationPermission = false;
        let notificationCount = 0;

        const showLoader = (show) => {
            const loader = getElement('globalLoaderEl');
            if(loader) loader.style.display = show ? 'flex' : 'none';
        };

        const safeClick = (id, cb) => {
            const el = getElement(id);
            if(el) {
                el.removeEventListener('click', cb);
                el.addEventListener('click', cb);
            }
        };

        async function logTransaction(uid, amount, type, desc) {
            try {
                await push(ref(db, `user_transactions/${uid}`), {
                    amount: parseFloat(amount),
                    type: type,
                    description: desc,
                    timestamp: serverTimestamp()
                });
            } catch(e) { 
                console.error("Log error:", e); 
            }
        }

        // Initialize Firebase Messaging
        async function initializeMessaging() {
            try {
                // Check if messaging is supported
                const isMessagingSupported = await isSupported();
                if (!isMessagingSupported) {
                    console.log("Firebase Messaging is not supported in this browser");
                    return;
                }
                
                messaging = getMessaging(app);
                
                // Request permission and get token
                await requestNotificationPermission();
                
                // Listen for foreground messages
                onMessage(messaging, (payload) => {
                    console.log('Foreground message received:', payload);
                    showPushNotification(payload);
                    incrementNotificationCount();
                });
                
                // Listen for new notifications from database
                setupNotificationListener();
                
            } catch (error) {
                console.error("Messaging initialization error:", error);
            }
        }

        // Request notification permission
        async function requestNotificationPermission() {
            try {
                // Check current permission
                if (!('Notification' in window)) {
                    console.log('This browser does not support notifications');
                    return;
                }
                
                // Check if already granted
                if (Notification.permission === 'granted') {
                    notificationPermission = true;
                    await getFCMToken();
                    return;
                }
                
                // Don't ask on first load, ask when user opens notification settings
                console.log('Notification permission not granted yet');
                
            } catch (error) {
                console.error("Error getting notification permission:", error);
            }
        }

        // Get FCM Token
        async function getFCMToken() {
            try {
                const currentToken = await getToken(messaging, { vapidKey: VAPID_KEY });
                
                if (currentToken) {
                    fcmToken = currentToken;
                    console.log('FCM Token:', fcmToken);
                    
                    // Save token to user profile
                    if (currentUser) {
                        await update(ref(db, `users/${currentUser.uid}`), {
                            fcmToken: fcmToken,
                            notificationEnabled: true,
                            notificationPermission: 'granted',
                            notificationUpdated: serverTimestamp()
                        });
                    }
                    
                    // Register service worker
                    await registerServiceWorker();
                    
                    return currentToken;
                } else {
                    console.log('No registration token available.');
                    return null;
                }
            } catch (error) {
                console.error('An error occurred while retrieving token:', error);
                return null;
            }
        }

        // Register service worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('firebase-messaging-sw.js');
                    console.log('Service Worker registered with scope:', registration.scope);
                    
                    // Update FCM token in service worker
                    if (fcmToken && currentUser) {
                        await update(ref(db, `users/${currentUser.uid}/fcmToken`), fcmToken);
                    }
                    
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
        }

        // Setup listener for new notifications from database
        function setupNotificationListener() {
            if (!currentUser) return;
            
            // Listen for notifications sent to this user specifically
            const userNotificationsRef = ref(db, 'notifications');
            
            dbListeners.notifications = onChildAdded(userNotificationsRef, (snapshot) => {
                const notification = snapshot.val();
                
                // Check if notification is for this user or for all users
                const isForUser = notification.target === 'all' || 
                                 notification.target === currentUser.uid ||
                                 (notification.target === 'players' && userProfile.matchesPlayed > 0) ||
                                 (notification.specificUid === currentUser.uid);
                
                if (isForUser && notification.timestamp > Date.now() - 86400000) { // Last 24 hours
                    showPushNotification({
                        notification: {
                            title: notification.title,
                            body: notification.body || notification.message,
                            image: notification.icon || APP_ICON_URL
                        },
                        data: {
                            clickUrl: notification.url || 'https://hsytesports.in',
                            timestamp: notification.timestamp.toString()
                        }
                    });
                    
                    incrementNotificationCount();
                }
            });
        }

        // Show push notification
        function showPushNotification(payload) {
            // Check if notifications are enabled
            if (!userProfile.notificationEnabled && userProfile.notificationEnabled !== undefined) {
                return;
            }
            
            const title = payload.notification?.title || payload.data?.title || 'HSYT ESPORTS';
            const body = payload.notification?.body || payload.data?.body || '';
            const icon = payload.notification?.icon || payload.data?.icon || APP_ICON_URL;
            const image = payload.notification?.image || payload.data?.image;
            const clickUrl = payload.data?.clickUrl || 'https://hsytesports.in';
            
            // Create notification
            if (Notification.permission === 'granted') {
                const notificationOptions = {
                    body: body,
                    icon: icon,
                    badge: APP_ICON_URL,
                    tag: 'hsyt-notification',
                    data: { url: clickUrl },
                    timestamp: parseInt(payload.data?.timestamp) || Date.now()
                };
                
                if (image) {
                    notificationOptions.image = image;
                }
                
                const notification = new Notification(title, notificationOptions);
                
                // Handle click
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.open(clickUrl, '_blank');
                    notification.close();
                };
                
                // Auto close after 10 seconds
                setTimeout(() => {
                    notification.close();
                }, 10000);
            }
            
            // Also show in-app notification if app is open
            showInAppNotification(title, body, clickUrl);
        }

        // Show in-app notification
        function showInAppNotification(title, body, url = null) {
            // Create notification element
            const notificationEl = document.createElement('div');
            notificationEl.className = 'animate-enter';
            notificationEl.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: linear-gradient(135deg, #4F46E5, #7C3AED);
                color: white;
                padding: 15px 20px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.3);
                z-index: 99999;
                max-width: 350px;
                min-width: 300px;
                cursor: pointer;
                border-left: 4px solid var(--accent-cyan);
                animation: slideIn 0.3s ease-out;
            `;
            
            notificationEl.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <div style="background: rgba(255,255,255,0.2); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <img src="${APP_ICON_URL}" 
                             alt="App Icon" 
                             style="width: 24px; height: 24px; border-radius: 6px; object-fit: cover;">
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 4px;">${title}</div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">${body}</div>
                    </div>
                    <button class="close-notif-btn" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notificationEl);
            
            // Add click handler
            notificationEl.addEventListener('click', function(e) {
                if (!e.target.closest('.close-notif-btn')) {
                    if (url) {
                        window.open(url, '_blank');
                    }
                    this.remove();
                }
            });
            
            // Add close button handler
            notificationEl.querySelector('.close-notif-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                notificationEl.remove();
            });
            
            // Auto remove after 8 seconds
            setTimeout(() => {
                if (notificationEl.parentNode) {
                    notificationEl.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (notificationEl.parentNode) {
                            notificationEl.remove();
                        }
                    }, 300);
                }
            }, 8000);
            
            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }

        // Increment notification count
        function incrementNotificationCount() {
            notificationCount++;
            updateNotificationBadge();
        }

        // Update notification badge
        function updateNotificationBadge() {
            const notificationItems = document.querySelectorAll('.nav-item[data-section="notifications-section"]');
            notificationItems.forEach(item => {
                // Remove existing badge
                const existingBadge = item.querySelector('.notification-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                // Add new badge if count > 0
                if (notificationCount > 0) {
                    const badge = document.createElement('div');
                    badge.className = 'notification-badge';
                    badge.textContent = notificationCount > 9 ? '9+' : notificationCount;
                    badge.style.position = 'absolute';
                    badge.style.top = '10px';
                    badge.style.right = '10px';
                    item.style.position = 'relative';
                    item.appendChild(badge);
                }
            });
        }

        // Reset notification count
        function resetNotificationCount() {
            notificationCount = 0;
            updateNotificationBadge();
        }

        async function loadWalletTransactions() {
            const list = getElement('transactionList');
            if(!list || !currentUser) return;
            
            list.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-light"></div></div>';

            try {
                const q = ref(db, `user_transactions/${currentUser.uid}`);
                const snap = await get(q);

                if (!snap.exists()) {
                    list.innerHTML = '<div style="text-align:center; color:#A0A0B8; margin-top:30px;">No transactions yet.</div>';
                    return;
                }

                const data = [];
                snap.forEach(c => data.push(c.val()));
                data.reverse();

                let html = '';
                data.forEach(t => {
                    const color = t.type === 'credit' ? '#4CAF50' : '#FF3D71';
                    const sign = t.type === 'credit' ? '+' : '-';
                    const date = t.timestamp ? new Date(t.timestamp).toLocaleDateString() : 'Recent';
                    
                    html += `
                        <div class="animate-enter" style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
                            <div>
                                <div style="color:white; font-weight:500;">${t.description}</div>
                                <div style="color:#A0A0B8; font-size:0.75rem;">${date}</div>
                            </div>
                            <div style="color:${color}; font-weight:700; font-size:1rem;">
                                ${sign}${parseFloat(t.amount).toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                list.innerHTML = html;

            } catch (e) {
                console.error(e);
                list.innerHTML = '<div class="text-danger text-center">Failed to load history.</div>';
            }
        }

        function renderPageContent(sectionId, data = {}) {
            const section = getElement(sectionId);
            if (!section) return;
            
            if (['match-details-section', 'tournaments-section', 'slot-selection-section', 'player-details-section', 'match-result-section'].includes(sectionId)) {
                section.innerHTML = '';
            }
            if (section.innerHTML.trim() !== '') return;

            let content = '';
            if (sectionId === 'login-section') {
                content = `
                    <div class="container" style="max-width: 450px; margin-top: 5vh;">
                        <div class="text-center mb-4 animate-pop">
                            <!-- Updated App Logo -->
                            <img src="${APP_ICON_URL}" 
                                 alt="App Logo" 
                                 id="loginLogoEl" 
                                 class="app-logo app-logo-large"
                                 style="border: 3px solid var(--accent-cyan); box-shadow: 0 0 20px rgba(0, 224, 255, 0.4);">
                        </div>
                        <div class="card custom-card animate-enter"> 
                            <div class="card-body p-4">
                                <form id="emailLoginForm">
                                    <h3 class="text-center mb-4 text-white">Welcome to BATTLE-BOY</h3>
                                    <div class="mb-3"><input type="email" class="form-control" id="loginEmailInputEl" placeholder="Email" required></div>
                                    <div class="mb-3"><input type="password" class="form-control" id="loginPasswordInputEl" placeholder="Password" required></div>
                                    <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                                    <div class="d-grid mt-4"><button type="button" id="loginEmailBtnEl" class="btn btn-lg" style="background-color: var(--accent-pink); color: white;">Login</button></div>
                                    <button type="button" id="showSignupToggleBtnEl" class="btn btn-link d-block text-center mt-3" style="color: var(--text-secondary); text-decoration: none;">Create an account</button>
                                </form>
                                <form id="emailSignupForm" style="display: none;">
                                    <h3 class="text-center mb-4 text-white">Join BATTLE-BOY</h3>
                                    <div class="mb-3"><input type="text" class="form-control" id="signupNameInputEl" placeholder="Full Name" required></div>
                                    <div class="mb-3"><input type="email" class="form-control" id="signupEmailInputEl" placeholder="Email" required></div>
                                    <div class="mb-3"><input type="password" class="form-control" id="signupPasswordInputEl" placeholder="Password" required></div>
                                    <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div>
                                    <div class="d-grid mt-4"><button type="button" id="signupEmailBtnEl" class="btn btn-lg" style="background-color: var(--accent-cyan); color: var(--bg-primary);">Sign Up</button></div>
                                    <button type="button" id="showLoginToggleBtnEl" class="btn btn-link d-block text-center mt-3" style="color: var(--text-secondary); text-decoration: none;">Back to Login</button>
                                </form>
                            </div>
                        </div>
                    </div>`;
            } else if (sectionId === 'home-section') {
                content = `
                    <div id="promotionSlider" class="swiper animate-enter mt-3" style="display:none;"><div class="swiper-wrapper"></div><div class="swiper-pagination"></div></div>
                    <div class="my-contests animate-enter" style="animation-delay: 0.1s;">
                        <div class="section-header">
                            <h2>My Contests</h2>
                            <p>Your Tournaments Journey</p>
                        </div>
                        <div class="contest-categories">
                            <div class="category-card" data-status-target="ongoing"><div class="icon-circle"><i class="fas fa-play"></i></div><span>ONGOING</span></div>
                            <div class="category-card" data-status-target="upcoming"><div class="icon-circle"><i class="fas fa-history"></i></div><span>UPCOMING</span></div>
                            <div class="category-card" data-status-target="completed"><div class="icon-circle"><i class="fas fa-check"></i></div><span>RESULT</span></div>
                        </div>
                    </div>
                    <div class="exclusive-tournaments animate-enter" style="animation-delay: 0.2s;">
                        <div class="section-header">
                            <div class="d-flex align-items-center justify-content-center gap-3 mb-2">
                                <img src="${APP_ICON_URL}" 
                                     alt="App Icon" 
                                     class="app-logo app-logo-small"
                                     style="width: 40px; height: 40px; border-radius: 8px;">
                                <h2 class="mb-0">BATTLE-BOY</h2>
                            </div>
                            <p>Big Winnings For All</p>
                        </div>
                        <div class="game-grid" id="gamesListEl"></div>
                    </div>`;
            } else if (sectionId === 'profile-section') {
                content = `
                    <div class="profile-new-header animate-enter">
                        <div class="d-flex align-items-center gap-3">
                            <div class="profile-new-avatar" id="profileCardAvatar">
                                <img src="${APP_ICON_URL}" 
                                     alt="App Icon" 
                                     style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                            </div>
                            <div class="profile-new-info">
                                <h3 id="profileCardName">User</h3>
                                <p id="profileCardPhone">8563XXXXXX</p>
                            </div>
                        </div>
                        <div class="profile-edit-btn"><i class="fas fa-pen"></i></div>
                    </div>

                    <div class="profile-stats-card animate-enter" style="animation-delay: 0.1s;">
                        <div class="p-stat-item"><i class="p-stat-icon fas fa-gamepad"></i><span class="p-stat-val count-up" data-val="0">0</span><span class="p-stat-label">Matches Played</span></div>
                        <div class="p-stat-item"><i class="p-stat-icon fas fa-fire"></i><span class="p-stat-val count-up" data-val="0">0</span><span class="p-stat-label">Total Kills</span></div>
                        <div class="p-stat-item"><i class="p-stat-icon fas fa-trophy"></i><span class="p-stat-val count-up" data-prefix="" data-val="0.00">0.00</span><span class="p-stat-label">Total Winnings</span></div>
                    </div>

                    <div class="profile-menu-card animate-enter" style="animation-delay: 0.2s;">
                        <a href="#" class="p-menu-item" data-section="history-section"><i class="p-menu-icon fas fa-history"></i><span class="p-menu-text">My Matches</span><i class="p-menu-arrow fas fa-chevron-right"></i></a>
                        <a href="#" class="p-menu-item" data-section="wallet-section"><i class="p-menu-icon fas fa-file-invoice-dollar"></i><span class="p-menu-text">Transaction History</span><i class="p-menu-arrow fas fa-chevron-right"></i></a>
                        <a href="#" class="p-menu-item" data-section="earn-section"><i class="p-menu-icon fas fa-users"></i><span class="p-menu-text">My Referrals</span><i class="p-menu-arrow fas fa-chevron-right"></i></a>
                        <a href="#" class="p-menu-item" data-section="notifications-section"><i class="p-menu-icon fas fa-bell"></i><span class="p-menu-text">Notifications</span><i class="p-menu-arrow fas fa-chevron-right"></i></a>
                        <div class="menu-divider"></div>
                        <a href="#" class="p-menu-item" data-section="ai-assistant-section"><i class="p-menu-icon fas fa-wand-magic-sparkles text-cyan"></i><span class="p-menu-text text-cyan">AI Assistant</span><i class="p-menu-arrow fas fa-chevron-right"></i></a>
                        <a href="#" class="p-menu-item" data-section="support-section"><i class="p-menu-icon fas fa-headset"></i><span class="p-menu-text">Customer Support</span><i class="p-menu-arrow fas fa-chevron-right"></i></a>
                        <a href="#" class="p-menu-item" data-section="privacy-policy-section"><i class="p-menu-icon fas fa-shield-halved"></i><span class="p-menu-text">Privacy Policy</span><i class="p-menu-arrow fas fa-chevron-right"></i></a>
                        <a href="#" class="p-menu-item" onclick="alert('About Us')"><i class="p-menu-icon fas fa-circle-info"></i><span class="p-menu-text">About Us</span><i class="p-menu-arrow fas fa-chevron-right"></i></a>
                        <div class="menu-divider"></div>
                        <a href="#" class="p-menu-item" id="logoutBtn"><i class="p-menu-icon fas fa-right-from-bracket text-red"></i><span class="p-menu-text text-red">Logout</span><i class="p-menu-arrow fas fa-chevron-right"></i></a>
                    </div>`;
            } else if (sectionId === 'wallet-section') {
                const totalBal = parseFloat(userProfile.balance || 0);
                const winBal = parseFloat(userProfile.winningBalance || 0);
                const depBal = totalBal - winBal;

                content = `
                    <div class="wallet-card animate-enter">
                        <div class="wallet-label">Total Balance</div>
                        <div class="wallet-balance"><span id="walletPageTotalBalance">${totalBal.toFixed(2)}</span></div>
                        <div class="wallet-divider"></div>
                        <div class="wallet-details">
                            <div>
                                <div class="wallet-label">Deposit</div>
                                <div class="wallet-sub-value"><span id="walletPageDeposit">${depBal.toFixed(2)}</span></div>
                            </div>
                            <div class="text-end">
                                <div class="wallet-label">Winnings</div>
                                <div class="wallet-sub-value"><span id="walletPageWinnings">${winBal.toFixed(2)}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="wallet-actions animate-enter" style="animation-delay: 0.1s;">
                        <button class="btn-action btn-add" id="addMoneyBtn"><i class="fas fa-plus-circle"></i> ADD MONEY</button>
                        <button class="btn-action btn-withdraw" id="withdrawBtn"><i class="fas fa-wallet"></i> WITHDRAW</button>
                    </div>
                    <div class="transactions-section animate-enter" style="animation-delay: 0.2s;">
                        <h3 style="font-size:1.1rem; font-weight:600; margin-bottom:15px;">Recent Transactions</h3>
                        <div id="transactionList" style="text-align:center; color:#A0A0B8; margin-top:50px;">No transactions yet.</div>
                    </div>`;
            } else if (sectionId === 'add-money-section') {
                 content = `
                    <div class="am-input-group animate-enter">
                        <span class="am-currency-symbol"></span>
                        <input type="number" class="am-input" id="addMoneyInput" placeholder="Enter Amount (12 - 10000)">
                    </div>
                    <button class="btn-cyan-block animate-enter" style="animation-delay:0.1s;" id="proceedPayBtn">Proceed to Pay</button>
                    
                    <div class="instruction-card animate-enter" style="animation-delay:0.2s;">
                        <div class="instruction-title">Important Instructions</div>
                        <div class="instruction-item">
                            <i class="instruction-icon fas fa-qrcode"></i>
                            <div class="instruction-text">You will be redirected to a secure payment page.</div>
                        </div>
                        <div class="instruction-item">
                            <i class="instruction-icon fas fa-stopwatch"></i>
                            <div class="instruction-text">Please wait for the loading to finish before making the payment.</div>
                        </div>
                        <div class="instruction-item">
                            <i class="instruction-icon fas fa-mobile-alt"></i>
                            <div class="instruction-text">After successful payment, the page will automatically confirm your transaction.</div>
                        </div>
                        <div class="instruction-item">
                            <i class="instruction-icon fas fa-headset"></i>
                            <div class="instruction-text">If your wallet is not updated after a while, please contact support.</div>
                        </div>
                    </div>
                `;
            } else if (sectionId === 'withdraw-section') {
                content = `
                    <div class="withdraw-balance-card animate-enter"><div class="wb-left"><i class="fas fa-wallet wb-icon"></i><span>Withdrawable Balance</span></div><div class="wb-amount"><span id="withdrawPageBalance">0.00</span></div></div>
                    <div class="withdraw-form animate-enter" style="animation-delay: 0.1s;"><div class="mb-3"><input type="number" class="form-control custom-input" id="withdrawAmount" placeholder="Amount to Withdraw (50 - 5000)"></div><div class="mb-3"><input type="text" class="form-control custom-input" id="withdrawUpi" placeholder="Your UPI ID (e.g., yourname@upi)"></div><button class="btn-cyan-block" id="submitWithdrawBtn">Submit Request</button></div>`;
            } else if (sectionId === 'earn-section') {
                content = `
                    <div class="referral-card-main animate-enter">
                        <div class="referral-title">Share Your Code & Earn</div>
                        <div class="referral-code-box" id="myReferralCodeDisplay">LOADING</div>
                        <div class="referral-actions">
                            <button class="btn-ref-copy" id="copyRefCodeBtn"><i class="far fa-copy"></i> COPY</button>
                            <button class="btn-ref-share" id="shareRefCodeBtn"><i class="fas fa-share-alt"></i> SHARE</button>
                        </div>
                    </div>
                    <div class="referral-stats-grid animate-enter" style="animation-delay: 0.1s;">
                        <div class="ref-stat-card"><span class="ref-stat-val" id="refCountVal">0</span><span class="ref-stat-label">Friends Joined</span></div>
                        <div class="ref-stat-card"><span class="ref-stat-val" id="refEarningsVal">0</span><span class="ref-stat-label">Total Earnings</span></div>
                    </div>
                    <div class="recent-referrals-section animate-enter" style="animation-delay: 0.2s;">
                        <div class="recent-ref-title">Recent Referrals</div>
                        <div class="empty-ref-state">No one has joined using your code yet.</div>
                    </div>`;
            } else if (sectionId === 'ai-assistant-section') {
                content = `
                    <div class="chat-layout">
                        <div class="chat-messages-container" id="chatMessagesBox">
                            <div class="message-row bot animate-enter">
                                <div class="chat-bot-avatar">
                                    <img src="${APP_ICON_URL}" 
                                         alt="App Icon" 
                                         style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                </div>
                                <div class="chat-bubble bot">Hello! I'm your BATTLE-BOY Assistant. You can now send text messages along with images for better support. How can I help you today?</div>
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <input type="file" id="chatImageInput" accept="image/*" style="display: none;">
                            <div class="image-upload-container">
                                <button class="chat-image-btn" id="chatImageBtn"><i class="fas fa-camera"></i></button>
                                <input type="text" class="chat-input-field" id="chatInput" placeholder="Type your message...">
                                <button class="chat-send-btn" id="chatSendBtn"><i class="fas fa-paper-plane"></i></button>
                            </div>
                            <div id="imagePreviewContainer" style="display:none; margin-top:10px; text-align:center;">
                                <div class="image-preview-container">
                                    <img id="chatImagePreview" class="chat-image-preview">
                                    <button class="remove-image-btn" id="removeImageBtn"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (sectionId === 'support-section') {
                content = `
                    <div class="support-grid animate-enter">
                        <div class="support-card" id="btnSupportWhatsapp"><div class="support-icon icon-whatsapp"><i class="fab fa-whatsapp"></i></div><div class="support-name">WhatsApp</div></div>
                        <div class="support-card" id="btnSupportTelegram"><div class="support-icon icon-telegram"><i class="fab fa-telegram-plane"></i></div><div class="support-name">Telegram</div></div>
                        <div class="support-card" id="btnSupportInstagram"><div class="support-icon icon-instagram"><i class="fab fa-instagram"></i></div><div class="support-name">Instagram</div></div>
                        <div class="support-card" id="btnSupportYoutube"><div class="support-icon icon-youtube"><i class="fab fa-youtube"></i></div><div class="support-name">YouTube</div></div>
                        <div class="support-card" id="btnSupportEmail"><div class="support-icon icon-email"><i class="fas fa-envelope"></i></div><div class="support-name">Email</div></div>
                        <div class="support-card" id="btnSupportWebsite"><div class="support-icon icon-website"><i class="fas fa-globe"></i></div><div class="support-name">Our Website</div></div>
                    </div>`;
            } else if (sectionId === 'privacy-policy-section') {
                content = `
                    <div class="privacy-container animate-enter" style="padding: 5px;">
                        <div id="privacyContentLoader" class="text-center mt-5"><div class="spinner-border text-light"></div></div>
                        <div id="privacyPolicyContent" class="privacy-content" style="display:none;"></div>
                    </div>
                `;
            } else if (sectionId === 'preparing-payment-section') {
                content = `<div class="preparing-container"><div class="countdown-circle"><div class="countdown-ripple"></div><svg class="countdown-svg" viewBox="0 0 100 100"><circle class="countdown-circle-bg" cx="50" cy="50" r="45"></circle><circle class="countdown-circle-progress" cx="50" cy="50" r="45"></circle></svg><div class="countdown-number" id="preparingCountdownNum">5</div></div><h4 class="mb-2">Preparing Secure Payment...</h4><p class="text-secondary small">Please wait while we connect you to the payment gateway.</p></div>`;
            } else if (sectionId === 'payment-qr-section') {
                content = `
                    <div class="payment-qr-card animate-pop">
                        <button class="close-qr-btn" id="closeQrBtn"><i class="fas fa-times"></i></button>
                        <div class="pay-header">
                            <div class="upi-logo-box">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg" alt="UPI">
                            </div>
                            <div class="pay-info">
                                <p class="mb-0 text-secondary" style="font-size:0.8rem">Paying to</p>
                                <h4>HSYT-FF <i class="fas fa-check-circle text-warning"></i></h4>
                                <span>Verified Business</span>
                            </div>
                        </div>
                        <p class="text-center text-white mb-3">Scan this QR to complete payment</p>
                        <div class="qr-container">
                            <img id="dynamicQrImg" src="" class="qr-image" alt="QR Code">
                        </div>
                        <div class="qr-timer">Checking payment status in <span id="paymentTimer">05:00</span></div>
                        <div class="payment-loader"><span></span><span></span><span></span><span></span><span></span></div>
                        <button class="btn-paytm" onclick="alert('Redirecting to Paytm...')">
                            Pay via <img src="https://upload.wikimedia.org/wikipedia/commons/5/5c/Paytm_Logo_%28standalone%29.svg" height="20" alt="Paytm">
                        </button>
                        <button class="btn-download-qr">
                            <i class="fas fa-download"></i> Download QR code
                        </button>
                        <div class="payment-details-footer">
                            <div class="detail-row"><span>Order ID:</span><span id="payOrderId">#TOURNA_...</span></div>
                            <div class="detail-row"><span>Order Amount:</span><span id="payOrderAmount">0.00</span></div>
                        </div>
                        <button class="btn-verify-payment" id="openVerifyBtn">Verify Payment</button>
                    </div>

                    <div id="paymentVerificationModal" class="verification-modal" style="display:none;">
                        <div class="verification-card">
                            <h4>Verify Transaction</h4>
                            <div class="mb-3"><label>Your UPI ID</label><input type="text" id="verifyUpiId" class="form-control custom-input"></div>
                            <div class="mb-3"><label>UTR / Ref Number</label><input type="text" id="verifyUtr" class="form-control custom-input"></div>
                            <div class="d-flex gap-2"><button class="btn btn-secondary flex-grow-1" id="cancelVerifyPayment">Cancel</button><button class="btn btn-success flex-grow-1" id="submitVerifyPayment">Submit</button></div>
                        </div>
                    </div>
                `;
            } else if (sectionId === 'history-section') {
                content = `
                    <div class="tournament-tabs animate-enter" style="margin-top:10px;">
                        <button class="tab-item active" data-status="upcoming">Upcoming</button>
                        <button class="tab-item" data-status="ongoing">Ongoing</button>
                        <button class="tab-item" data-status="completed">Completed</button>
                    </div>
                    <div id="tournamentsListContainerEl" class="animate-enter" style="padding-bottom:80px;">
                        <div class="text-center p-5"><div class="spinner-border text-light"></div></div>
                    </div>
                `;
            } else if (sectionId === 'tournaments-section') {
                content = `<div class="tournament-tabs animate-enter"><button class="tab-item active" data-status="upcoming">Upcoming</button><button class="tab-item" data-status="ongoing">Ongoing</button><button class="tab-item" data-status="completed">Results</button></div><div id="tournamentsListContainerEl" class="animate-enter" style="animation-delay: 0.1s;"></div>`;
            } else if (sectionId === 'match-details-section') {
                const banner = data.bannerUrl || data.gameImage || 'https://via.placeholder.com/600x300';
                const title = data.name || "Match Title";
                const date = (data.matchDate || "Upcoming") + ", " + (data.matchTime || "");
                
                let isJoined = false;
                if (currentUser && data.participants) {
                    isJoined = Object.values(data.participants).some(p => p && p.userId === currentUser.uid);
                }

                let footerHtml = '';
                
                if (isJoined) {
                    footerHtml = `
                        <div class="md-fixed-footer">
                            <button class="btn-join-match" style="background: linear-gradient(90deg, #28a745, #218838); cursor: default; box-shadow:none;">
                                ALREADY JOINED <i class="fas fa-check-circle"></i>
                            </button>
                            <button class="btn-room-details" id="btnShowRoomDetails">
                                <i class="fas fa-door-closed"></i> VIEW ROOM DETAILS
                            </button>
                        </div>`;
                } else if (data.status === 'completed') {
                    footerHtml = `<div style="padding: 0 20px 30px;"><button class="btn-view-result" id="btnViewResult"> VIEW WINNERS & RESULT</button></div>`;
                } else {
                    footerHtml = `<div class="md-fixed-footer"><button class="btn-join-match" id="mdJoinBtn">JOIN NOW (${data.entryFee || 0})</button></div>`;
                }

                let participantsHtml = '<div class="text-center p-3 text-secondary">No participants yet.</div>';
                if(data.participants) {
                    participantsHtml = Object.values(data.participants).filter(p => p).map((p, i) => 
                        `<div class="participant-row"><span class="participant-index">${i+1}</span><span class="participant-name">${p.inGameName || 'Unknown'}</span></div>`
                    ).join('');
                }

                let prizesHtml = `
                    <div class="prize-row"><div class="prize-rank"><i class="fas fa-trophy prize-icon"></i> Rank #1</div><div class="prize-amount">${data.prizePool * 0.5}</div></div>
                    <div class="prize-row"><div class="prize-rank">Rank #2</div><div class="prize-amount">${data.prizePool * 0.3}</div></div>
                    <div class="prize-row"><div class="prize-rank">Per Kill</div><div class="prize-amount">${data.perKill || 0}</div></div>
                `;

                content = `
                <div class="md-container animate-enter">
                    <div class="md-header-overlay">
                        <button class="md-back-btn" id="mdBackBtn"><i class="fas fa-arrow-left"></i></button>
                        <img src="${APP_ICON_URL}" 
                             alt="App Icon" 
                             style="width: 40px; height: 40px; border-radius: 8px; margin-left: 15px;">
                    </div>
                    <img src="${banner}" class="md-banner" onerror="this.onerror=null;this.src='https://placehold.co/600x300/151530/00E0FF?text=GAME+ZONE';">
                    
                    <div class="md-title-overlay">
                        <h4 class="text-white-50 small text-uppercase mb-1" style="font-size:0.7rem; letter-spacing:2px;">Tournament</h4>
                        <h2 class="md-match-title">${title}</h2>
                    </div>

                    <div class="md-meta-grid">
                        <div class="md-meta-item"><div class="md-meta-label">TYPE</div><div class="md-meta-val"><i class="fas fa-user"></i> ${data.type || 'Solo'}</div></div>
                        <div class="md-meta-item"><div class="md-meta-label">VERSION</div><div class="md-meta-val"><i class="fas fa-eye"></i> TPP</div></div>
                        <div class="md-meta-item"><div class="md-meta-label">MAP</div><div class="md-meta-val"><i class="fas fa-map"></i> ${data.map || 'Bermuda'}</div></div>
                    </div>

                    <div class="md-time-card"><i class="fas fa-clock md-time-icon"></i><span class="md-time-text">${date}</span></div>

                    <div class="md-stats-grid">
                        <div class="md-stat-card"><h5>PRIZE POOL</h5><span>${data.prizePool}</span></div>
                        <div class="md-stat-card"><h5>PER KILL</h5><span>${data.perKill}</span></div>
                        <div class="md-stat-card"><h5>ENTRY FEE</h5><span>${data.entryFee}</span></div>
                    </div>

                    <div class="md-tabs">
                        <button class="md-tab active" data-tab="about">ABOUT</button>
                        <button class="md-tab" data-tab="prizes">PRIZES</button>
                        <button class="md-tab" data-tab="participants">PARTICIPANTS</button>
                    </div>

                    <div class="md-content-box">
                        <div id="tab-about" class="tab-content-area active">
                            <div class="md-section-title">MATCH RULES</div>
                            <div class="md-text-block">
                                ${data.rules ? data.rules.replace(/\n/g, '<br>') : 'No rules specified.'}
                            </div>
                        </div>
                        <div id="tab-prizes" class="tab-content-area">${prizesHtml}</div>
                        <div id="tab-participants" class="tab-content-area">${participantsHtml}</div>
                    </div>

                    ${footerHtml}
                </div>`;
            }
            else if (sectionId === 'match-result-section') {
                const title = data.name || "Match Result";
                const date = data.matchDate || "Date";

                content = `
                    <div class="app-header" style="position:sticky; top:0; background:var(--bg-primary);">
                        <div class="header-left d-flex align-items-center gap-3">
                             <button class="border-0 bg-transparent text-white fs-5" id="resBackBtn"><i class="fas fa-arrow-left"></i></button>
                             <img src="${APP_ICON_URL}" 
                                  alt="App Icon" 
                                  style="width: 40px; height: 40px; border-radius: 8px;">
                             <div class="fs-5 fw-bold text-white">${title}</div>
                        </div>
                    </div>
                    
                    <div class="result-meta">Organised on ${date}</div>
                    
                    <div class="md-stats-grid">
                        <div class="md-stat-card"><h5>PRIZE POOL</h5><span>${data.prizePool || 0}</span></div>
                        <div class="md-stat-card"><h5>PER KILL</h5><span>${data.perKill || 0}</span></div>
                        <div class="md-stat-card"><h5>ENTRY FEE</h5><span>${data.entryFee || 0}</span></div>
                    </div>

                    <div class="full-result-bar">FULL RESULT</div>
                    
                    <div class="result-table-header">
                        <div>#</div>
                        <div>PLAYER NAME</div>
                        <div class="text-center">RANK</div>
                        <div class="text-center">KILLS</div>
                        <div class="text-end">WINNING</div>
                    </div>
                    
                    <div class="result-list-container" id="realResultContainer">
                        <div class="text-center p-5"><div class="spinner-border text-light"></div></div>
                    </div>
                `;
            }
            else if (sectionId === 'slot-selection-section') {
                content = `
                    <div class="slot-list-header">
                        <span>SLOT</span>
                        <span>SELECT</span>
                    </div>
                    <div class="slot-list-scroll" id="slotListContainer">
                        <div class="text-center p-5"><div class="spinner-border text-light"></div></div>
                    </div>
                    <div class="slot-footer">
                        <div class="slot-footer-info">
                            <span>TOTAL ENTRY FEE</span>
                            <strong id="slotTotalFee">0</strong>
                        </div>
                        <button class="btn-slot-next" id="slotNextBtn">NEXT</button>
                    </div>
                `;
            } else if (sectionId === 'player-details-section') {
                content = `
                    <div id="playerDetailsFormContainer">
                    </div>
                    <div class="details-footer">
                        <div class="details-total-text">TOTAL FEE: <strong id="detailsTotalFee">0</strong></div>
                        <button class="btn-details-confirm" id="btnConfirmJoin">CONFIRM & JOIN</button>
                    </div>
                `;
            } else if (sectionId === 'notifications-section') {
                content = `
                    <div class="notification-settings-card animate-enter">
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <img src="${APP_ICON_URL}" 
                                 alt="App Icon" 
                                 style="width: 40px; height: 40px; border-radius: 8px;">
                            <h5 class="text-white mb-0"><i class="fas fa-bell me-2"></i> Notification Settings</h5>
                        </div>
                        
                        <div class="notification-toggle">
                            <div>
                                <div class="fw-bold text-white">Push Notifications</div>
                                <div class="text-secondary small">Receive notifications for matches, results, and updates</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="pushNotificationsToggle" ${userProfile.notificationEnabled !== false ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="notification-toggle">
                            <div>
                                <div class="fw-bold text-white">Match Alerts</div>
                                <div class="text-secondary small">Get notified when new tournaments are created</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="matchAlertsToggle" ${userProfile.notificationMatchAlerts !== false ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="notification-toggle">
                            <div>
                                <div class="fw-bold text-white">Result Updates</div>
                                <div class="text-secondary small">Receive notifications when match results are published</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="resultUpdatesToggle" ${userProfile.notificationResults !== false ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="notification-toggle">
                            <div>
                                <div class="fw-bold text-white">Promotional Offers</div>
                                <div class="text-secondary small">Get notified about special offers and bonuses</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="promoOffersToggle" ${userProfile.notificationPromo !== false ? 'checked' : ''}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="mt-4 pt-3 border-top border-secondary">
                            <button class="btn btn-outline-primary w-100" id="requestPermissionBtn">
                                <i class="fas fa-key me-2"></i> Enable Browser Notifications
                            </button>
                            <div class="text-center mt-2">
                                <small class="text-secondary">Current Status: <span id="permissionStatus" class="fw-bold">${Notification.permission}</span></small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="notification-settings-card animate-enter" style="animation-delay: 0.1s;">
                        <h5 class="text-white mb-3"><i class="fas fa-history me-2"></i> Recent Notifications</h5>
                        <div id="recentNotificationsList" class="text-center p-4">
                            <div class="spinner-border spinner-border-sm text-light"></div>
                            <div class="text-secondary mt-2">Loading notifications...</div>
                        </div>
                    </div>
                `;
            } else if (sectionId === 'leaderboard-section') {
                content = `
                    <div class="d-flex flex-column justify-content-center align-items-center animate-enter" style="height:50vh">
                        <img src="${APP_ICON_URL}" 
                             alt="App Icon" 
                             class="app-logo app-logo-medium mb-3">
                        <p class="text-secondary text-center">No winners yet today.</p>
                    </div>`;
            } else {
                 if(!['login-section', 'home-section', 'profile-section', 'wallet-section', 'add-money-section', 'withdraw-section', 'earn-section', 'ai-assistant-section', 'support-section', 'preparing-payment-section', 'payment-qr-section', 'tournaments-section', 'match-details-section', 'leaderboard-section', 'slot-selection-section', 'player-details-section', 'match-result-section', 'notifications-section'].includes(sectionId)) {
                     content = `
                        <div class="text-center p-5 animate-enter">
                            <img src="${APP_ICON_URL}" 
                                 alt="App Icon" 
                                 class="app-logo app-logo-medium mb-3">
                            <h2 class="text-white">${sectionId.replace('-section', '').toUpperCase()}</h2>
                            <p class="text-secondary">Coming Soon.</p>
                        </div>`;
                 }
            }
            if(content) section.innerHTML = content;
            
            // Add copy to clipboard function
            if (sectionId === 'match-details-section') {
                window.copyToClipboard = (elementId) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        const text = element.textContent;
                        navigator.clipboard.writeText(text).then(() => {
                            const originalText = element.textContent;
                            element.textContent = 'Copied!';
                            element.style.color = '#00E0FF';
                            setTimeout(() => {
                                element.textContent = originalText;
                                element.style.color = 'white';
                            }, 2000);
                        });
                    }
                };
            }
        }

        function animateCounter() { 
            document.querySelectorAll('.count-up').forEach(el => { 
                const target = parseFloat(el.getAttribute('data-val')); 
                const prefix = el.getAttribute('data-prefix') || ''; 
                let start = 0; 
                const duration = 1000; 
                const step = target / (duration / 16); 
                function update() { 
                    start += step; 
                    if(start >= target) start = target; 
                    el.innerText = prefix + (target % 1 !== 0 ? start.toFixed(2) : Math.floor(start)); 
                    if(start < target) requestAnimationFrame(update); 
                } 
                update(); 
            }); 
        }
        
        function populateUserInfo(profile) { 
            getElement('headerUserGreeting').textContent =
                profile.displayName || 'Guest'; 

            const headerAvatar = getElement('headerAvatar');
            if (headerAvatar) {
                const img = headerAvatar.querySelector('img');
                if (img) {
                    img.src = APP_ICON_URL;
                } else {
                    headerAvatar.innerHTML = `
                        <img src="${APP_ICON_URL}" 
                             alt="App Icon" 
                             style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                    `;
                }
            }
            
            getElement('headerChipBalance').textContent =
                (profile.balance || 0).toFixed(0); 
        }

        function populateProfilePage(profile) { 
            if (!getElement('profileCardAvatar')) return; 

            const profileAvatar = getElement('profileCardAvatar');
            profileAvatar.innerHTML = `
                <img src="${APP_ICON_URL}" 
                     alt="App Icon" 
                     style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
            `;

            getElement('profileCardName').textContent =
                profile.displayName || 'User'; 

            getElement('profileCardPhone').textContent =
                profile.phone || profile.email || 'ID: 85xxxx'; 

            const statEls = document.querySelectorAll('.p-stat-val'); 
            if (statEls.length >= 3) { 
                statEls[0].setAttribute('data-val', profile.matchesPlayed || 0); 
                statEls[1].setAttribute('data-val', profile.totalKills || 0); 
                statEls[2].setAttribute('data-val', profile.totalWinnings || 0); 
            } 
        }
        
        function setupRealtimeListeners(uid) { 
            detachAllDbListeners(); 
            
            dbListeners.userProfile = onValue(ref(db, `users/${uid}`), (snapshot) => { 
                if (snapshot.exists()) { 
                    userProfile = snapshot.val(); 
                    populateUserInfo(userProfile); 
                    
                    if (getElement('profile-section').classList.contains('active')) {
                        populateProfilePage(userProfile); 
                    }

                    const totalBal = parseFloat(userProfile.balance || 0);
                    const winBal = parseFloat(userProfile.winningBalance || 0);
                    const depBal = totalBal - winBal;

                    if(getElement('walletPageTotalBalance')) getElement('walletPageTotalBalance').textContent = totalBal.toFixed(2);
                    if(getElement('walletPageDeposit')) getElement('walletPageDeposit').textContent = depBal.toFixed(2);
                    if(getElement('walletPageWinnings')) getElement('walletPageWinnings').textContent = winBal.toFixed(2);
                    if(getElement('withdrawPageBalance')) getElement('withdrawPageBalance').textContent = totalBal.toFixed(2);
                    if(getElement('headerChipBalance')) getElement('headerChipBalance').textContent = totalBal.toFixed(0);

                } else {
                    signOut(auth); 
                }
            }); 

            dbListeners.announcement = onValue(ref(db, 'settings/announcement'), (snap) => {
                if(snap.exists() && snap.val() && snap.val().trim() !== "") {
                    latestAnnouncement = " **Latest Update**\n\n" + snap.val();
                } else {
                    latestAnnouncement = " No new announcements at the moment.";
                }
            });
            
            dbListeners.appLogo = onValue(ref(db, 'settings/userAppLogoUrl'), (snap) => {
                const logoUrl = snap.val();
                const logoEl = getElement('loginLogoEl');
                if(logoEl && logoUrl && logoUrl.trim() !== '') {
                    logoEl.src = logoUrl;
                    
                    // Update all app icons
                    updateAllAppIcons(logoUrl);
                } else if (logoEl) {
                    logoEl.src = APP_ICON_URL;
                }
            });
        }
        
        // Function to update all app icons
        function updateAllAppIcons(newIconUrl) {
            // Update all logo images
            document.querySelectorAll('img[alt="App Icon"], img[alt="App Logo"]').forEach(img => {
                if (img.src !== newIconUrl) {
                    img.src = newIconUrl;
                }
            });
            
            // Update favicon
            const favicon = document.querySelector('link[rel="icon"]');
            if (favicon) favicon.href = newIconUrl;
            
            // Update apple touch icon
            const appleIcon = document.querySelector('link[rel="apple-touch-icon"]');
            if (appleIcon) appleIcon.href = newIconUrl;
            
            // Save to localStorage for cache
            localStorage.setItem('appIconUrl', newIconUrl);
        }
        
        function detachAllDbListeners() { 
            if(dbListeners.userProfile) dbListeners.userProfile(); 
            if(dbListeners.announcement) dbListeners.announcement();
            if(dbListeners.appLogo) dbListeners.appLogo();
            if(dbListeners.notifications) dbListeners.notifications();
            if(dbListeners.matchDetails) dbListeners.matchDetails();
            dbListeners = {}; 
        }
        
        async function handleAuthStateChange(user) { 
            showLoader(true); 
            detachAllDbListeners(); 
            currentUser = user; 
            if (user) { 
                const userRef = ref(db, 'users/' + user.uid); 
                const snapshot = await get(userRef); 
                if (!snapshot.exists()) { 
                    await set(userRef, { 
                        uid: user.uid, 
                        displayName: user.email.split('@')[0], 
                        email: user.email, 
                        balance: 0, 
                        winningBalance: 0,
                        matchesPlayed:0, 
                        totalKills:0, 
                        totalWinnings:0, 
                        createdAt: serverTimestamp(),
                        notificationEnabled: true,
                        notificationMatchAlerts: true,
                        notificationResults: true,
                        notificationPromo: true
                    }); 
                } 
                setupRealtimeListeners(user.uid); 
                showSection('home-section'); 
                
                // Initialize messaging after user is logged in
                setTimeout(() => {
                    initializeMessaging();
                }, 1000);
                
            } else { 
                userProfile = {}; 
                showSection('login-section'); 
            } 
            showLoader(false); 
        }
        
        async function loadAppSettings() { 
            try { 
                const snap = await get(ref(db, 'settings')); 
                if (snap.exists()) { 
                    appSettings = snap.val(); 
                } 
            } catch(e) { 
                console.error("Settings load error:", e);
            } 
        }
        
        async function loadPromotions() { 
            if (typeof Swiper === 'undefined') return; 
            const sliderEl = getElement('promotionSlider');
            if (!sliderEl) return;
            
            const wrapper = sliderEl.querySelector('.swiper-wrapper'); 
            if (!wrapper) return; 
            wrapper.innerHTML = ''; 
            try { 
                const snap = await get(ref(db, 'promotions')); 
                if (snap.exists()) { 
                    const promotions = Object.values(snap.val()).filter(p => p.imageUrl);
                    
                    if(promotions.length > 0) {
                        promotions.forEach(p => { 
                            if (p.imageUrl) {
                                const slide = document.createElement('div');
                                slide.className = 'swiper-slide';
                                if(p.link && p.link.trim() !== '') {
                                    slide.innerHTML = `<a href="${p.link}" target="_blank"><img src="${p.imageUrl}" alt="Promotion" onerror="this.src='https://placehold.co/600x300/151530/00E0FF?text=Promo'"></a>`;
                                } else {
                                    slide.innerHTML = `<img src="${p.imageUrl}" alt="Promotion" onerror="this.src='https://placehold.co/600x300/151530/00E0FF?text=Promo'">`;
                                }
                                wrapper.appendChild(slide);
                            }
                        }); 
                        
                        if(activeSwiper) {
                            activeSwiper.destroy();
                        }
                        
                        const swiperConfig = {
                            slidesPerView: 1, 
                            spaceBetween: 10, 
                            centeredSlides: true, 
                            autoplay: { delay: 3000, disableOnInteraction: false }, 
                            pagination: { el: '.swiper-pagination', clickable: true },
                            loop: promotions.length > 1
                        };
                        
                        activeSwiper = new Swiper(sliderEl, swiperConfig); 
                        sliderEl.style.display = 'block'; 
                    } else {
                        sliderEl.style.display = 'none'; 
                    }
                } else {
                    sliderEl.style.display = 'none'; 
                } 
            } catch (e) {
                console.error("Promotions load error:", e);
                sliderEl.style.display = 'none'; 
            } 
        }
        
        async function loadGameCategories() { 
            const list = getElement('gamesListEl'); 
            if (!list) return; 
            try { 
                const snap = await get(ref(db, 'games')); 
                if (!snap.exists()) { 
                    list.innerHTML = '<p style="grid-column:1/-1;text-align:center;">No games.</p>'; 
                    return; 
                } 
                list.innerHTML = ''; 
                Object.entries(snap.val()).forEach(([id, g]) => { 
                    if (!g || !g.name) return;
                    const div = document.createElement('div'); 
                    div.className = 'game-card animate-enter'; 
                    div.innerHTML = `
                        <img src="${g.imageUrl || 'https://via.placeholder.com/150'}" alt="${g.name}" onerror="this.src='https://placehold.co/150/151530/00E0FF?text=Game'">
                        <div class="game-title">${g.name}</div>
                    `; 
                    div.addEventListener('click', () => showSection('tournaments-section', { gameId: id, gameName: g.name, gameImage: g.imageUrl })); 
                    list.appendChild(div); 
                }); 
            } catch (e) { 
                console.error("Games load error:", e);
                list.innerHTML = '<p>Error loading games.</p>'; 
            } 
        }

        async function loadMatchesForCategory(gameId, status, gameData = {}) { 
            const container = getElement('tournamentsListContainerEl'); 
            if (!container) return; 
            container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-light"></div></div>`; 
            
            try { 
                const snap = await get(ref(db, 'tournaments')); 
                const allMatches = snap.exists() ? snap.val() : {}; 
                const matches = Object.entries(allMatches).filter(([, m]) => m.gameId === gameId && m.status === status); 
                
                if (matches.length === 0) { 
                    container.innerHTML = `<div class="text-center p-5 text-secondary animate-enter"><p>No ${status} matches found.</p></div>`; 
                    return; 
                } 
                
                renderMatchCards(container, matches, gameData.gameImage);
            } catch (e) { 
                console.error("Matches load error:", e);
                container.innerHTML = '<p class="text-center text-danger">Error loading matches.</p>'; 
            } 
        }

        async function loadUserMatches(status) { 
            const container = getElement('tournamentsListContainerEl'); 
            if (!container) return; 
            container.innerHTML = `<div class="text-center p-5"><div class="spinner-border text-light"></div></div>`; 
            
            try {
                const [tournamentsSnap, gamesSnap] = await Promise.all([
                    get(ref(db, 'tournaments')),
                    get(ref(db, 'games'))
                ]);

                const allMatches = tournamentsSnap.exists() ? tournamentsSnap.val() : {}; 
                const allGames = gamesSnap.exists() ? gamesSnap.val() : {};

                const matches = Object.entries(allMatches).filter(([id, m]) => {
                    if (m.status !== status) return false;
                    
                    if (!m.participants || !currentUser) return false;
                    
                    return Object.values(m.participants).some(p => p && p.userId === currentUser.uid);
                });
                
                if (matches.length === 0) { 
                    container.innerHTML = `<div class="text-center p-5 text-secondary animate-enter">
                        <i class="fas fa-ghost fa-2x mb-3"></i>
                        <p>You haven't joined any ${status} contests.</p>
                    </div>`; 
                    return; 
                } 
                
                matches.forEach(([, m]) => {
                    if (m.gameId && allGames[m.gameId]) {
                        m.fallbackGameImage = allGames[m.gameId].imageUrl;
                    }
                });
                
                renderMatchCards(container, matches, null);
            } catch(e) { 
                console.error("User matches load error:", e); 
                container.innerHTML = '<p class="text-center text-danger p-5">Error loading your matches.</p>'; 
            }
        }

        function renderMatchCards(container, matches, defaultImage) {
            container.innerHTML = ''; 
            
            const FALLBACK_IMG = "https://placehold.co/600x338/151530/00E0FF?text=GAME+ZONE"; 

            matches.forEach(([id, m]) => { 
                const d = document.createElement('div'); 
                d.className = 'tournament-card animate-enter'; 
                
                let bannerSrc = FALLBACK_IMG;
                if (m.bannerUrl && m.bannerUrl.length > 5) {
                    bannerSrc = m.bannerUrl;
                } else if (defaultImage && defaultImage.length > 5) {
                    bannerSrc = defaultImage;
                }

                const filled = m.filledSlots || 0;
                const total = m.totalSlots || 100;
                const progressPct = Math.min((filled / total) * 100, 100);
                
                let dateStr = m.matchDate || "Upcoming";
                if(m.matchTime) dateStr += `, ${m.matchTime}`;

                d.innerHTML = `
                    <img src="${bannerSrc}" class="t-banner-img" onerror="this.onerror=null;this.src='${FALLBACK_IMG}';">
                    <div class="t-content-body">
                        <div class="t-header-row">
                            <h4 class="t-title-text">${m.name}</h4>
                            <img src="${APP_ICON_URL}" 
                                 alt="App Icon" 
                                 style="width: 30px; height: 30px; border-radius: 6px;">
                        </div>
                        <div class="t-date-row"><i class="far fa-calendar-alt"></i> <span>${dateStr}</span></div>
                        <div class="t-stats-row">
                            <div class="t-stat-box"><span class="t-stat-label">PRIZE POOL</span><span class="t-stat-value">${m.prizePool || 0}</span></div>
                            <div class="t-stat-box"><span class="t-stat-label">PER KILL</span><span class="t-stat-value">${m.perKill || 0}</span></div>
                            <div class="t-stat-box"><span class="t-stat-label">ENTRY FEE</span><span class="t-stat-value">${m.entryFee || 0}</span></div>
                        </div>
                        <div class="t-progress-area">
                            <div class="t-progress-track"><div class="t-progress-bar" style="width: ${progressPct}%"></div></div>
                            <div class="t-slots-text">${filled}/${total} Slots Filled</div>
                        </div>
                    </div>`; 
                d.addEventListener('click', () => showSection('match-details-section', { ...m, id: id })); 
                container.appendChild(d); 
            });
        }

        let selectedSlots = [];
        async function renderSlotSelection(data) {
            const container = getElement('slotListContainer');
            const totalFeeEl = getElement('slotTotalFee');
            selectedSlots = [];
            totalFeeEl.textContent = "0";

            const takenSlots = [];
            try {
                const snap = await get(ref(db, `tournaments/${data.id}/participants`));
                if (snap.exists()) {
                    Object.keys(snap.val()).forEach(key => {
                        const slotNum = parseInt(key);
                        if(!isNaN(slotNum)) takenSlots.push(slotNum);
                    });
                }
            } catch (e) { console.error(e); }

            container.innerHTML = '';
            const totalSlots = data.totalSlots || 100;

            for (let i = 1; i <= totalSlots; i++) {
                const isTaken = takenSlots.includes(i);
                const row = document.createElement('div');
                row.className = `slot-row animate-enter ${isTaken ? 'disabled' : ''}`;
                row.style.animationDelay = (i * 0.01) + 's';
                row.innerHTML = `
                    <div class="slot-number">${i}</div>
                    <div class="slot-checkbox"></div>
                `;
                
                if (!isTaken) {
                    row.addEventListener('click', () => {
                        selectedSlots = [];
                        document.querySelectorAll('.slot-row').forEach(r => r.classList.remove('active'));
                        row.classList.add('active');
                        selectedSlots.push(i);
                        const fee = parseFloat(data.entryFee || 0);
                        totalFeeEl.textContent = "" + fee;
                    });
                }
                container.appendChild(row);
            }
        }

        function renderPlayerDetails(data) {
            const container = getElement('playerDetailsFormContainer');
            const totalFeeEl = getElement('detailsTotalFee');
            const slots = data.selectedSlots || [];
            
            totalFeeEl.textContent = "" + (slots.length * parseFloat(data.entryFee || 0));
            container.innerHTML = '';

            slots.forEach((slotNum, index) => {
                const div = document.createElement('div');
                div.className = 'details-card animate-enter';
                div.style.animationDelay = (index * 0.1) + 's';
                div.innerHTML = `
                    <div class="details-title">Player for Slot #${slotNum}</div>
                    <div class="details-input-box">
                        <label class="details-label">In-Game Name</label>
                        <input type="text" class="details-input slot-ign" data-slot="${slotNum}" placeholder="Enter Name">
                    </div>
                `;
                container.appendChild(div);
            });
            
            const btn = getElement('btnConfirmJoin');
            btn.classList.add('ready');
        }

        function startPaymentFlow(amount) { 
            showSection('preparing-payment-section'); 
            let count = 5; 
            const numEl = getElement('preparingCountdownNum'); 
            const circle = querySel('.countdown-circle-progress'); 
            if(numEl) numEl.innerText = count; 
            if(circle) circle.style.strokeDashoffset = 0; 
            const interval = setInterval(() => { 
                count--; 
                if(numEl) numEl.innerText = count; 
                if(circle) circle.style.strokeDashoffset = 283 - (count / 5) * 283; 
                if (count <= 0) { 
                    clearInterval(interval); 
                    showPaymentQR(amount); 
                } 
            }, 1000); 
        }
        
        function showPaymentQR(amount) { 
            showSection('payment-qr-section'); 
            const orderId = "#TOURNA_" + Math.floor(100000000 + Math.random() * 900000000); 
            if(getElement('payOrderId')) getElement('payOrderId').textContent = orderId; 
            if(getElement('payOrderAmount')) getElement('payOrderAmount').textContent = "" + parseFloat(amount).toFixed(2); 
            
            const upiLink = `upi://pay?pa=${ADMIN_UPI_ID}&pn=I-MAX&am=${amount}&tr=${orderId}&tn=AddMoney`; 
            if(getElement('dynamicQrImg')) getElement('dynamicQrImg').src = `https://i.ibb.co/XxqYyqtr/IMG-20260121-WA0024.jpg`;
            
            let timeLeft = 300; 
            const timerEl = getElement('paymentTimer'); 
            if (paymentTimerInterval) clearInterval(paymentTimerInterval); 
            paymentTimerInterval = setInterval(() => { 
                const m = Math.floor(timeLeft / 60); 
                const s = timeLeft % 60; 
                if(timerEl) timerEl.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; 
                timeLeft--; 
                if (timeLeft < 0) { 
                    clearInterval(paymentTimerInterval); 
                    if(timerEl) timerEl.textContent = "Timeout"; 
                    alert("Payment session expired."); 
                    showSection('wallet-section'); 
                } 
            }, 1000); 
        }

        async function uploadImageToStorage(file) {
            try {
                const timestamp = Date.now();
                const filename = `ai_chat/${currentUser.uid}_${timestamp}_${file.name}`;
                const fileRef = storageRef(storage, filename);
                
                await uploadBytes(fileRef, file);
                const downloadURL = await getDownloadURL(fileRef);
                return downloadURL;
            } catch (error) {
                console.error("Image upload failed:", error);
                throw error;
            }
        }

        function getSmartReply(text, imageUrl = null) {
            const lower = text.toLowerCase();
            const userName = userProfile.displayName || "Gamer";
            
            const totalBal = parseFloat(userProfile.balance || 0);
            const winBal = parseFloat(userProfile.winningBalance || 0);
            const depBal = totalBal - winBal;
            const refCode = userProfile.referralCode || "Generate in Profile";

            const APP_INFO = {
                minWithdraw: 50,
                minDeposit: 10,
                withdrawTime: "1-24 Hours",
                roomTime: "10-15 Mins before match",
                contactEmail: "support@hsytesports.in",
                contactTele: "@hsytesports"
            };

            if (imageUrl) {
                if (lower.match(/(deposit|payment|qr|upi|transaction)/)) {
                    return ` **Image Analysis - Payment Issue**\n\nI can see you've shared a payment screenshot. Here's what to do:\n\n1. **Verify Transaction**: Check if the UTR number is visible in your screenshot.\n2. **Wait 15 Minutes**: Payments sometimes take a few minutes to reflect.\n3. **Contact Support**: If issue persists, forward this screenshot to our support team with your UTR.\n\nWe'll help you resolve this quickly!`;
                } else if (lower.match(/(error|bug|issue|problem)/)) {
                    return ` **Technical Issue Detected**\n\nThanks for sharing the screenshot. I can see the problem.\n\n**Quick Fixes**:\n Clear app cache\n Restart the app\n Check for updates\n\nIf problem continues, our tech team will review your screenshot and contact you.`;
                } else if (lower.match(/(room|id|password|match)/)) {
                    return ` **Room Access Help**\n\nI see you're sharing room details. Remember:\n\n Room ID & Password appear 10 mins before match\n Join using the exact details\n Contact support if room is full or invalid\n\nGood luck for your match! `;
                } else {
                    return ` **Image Received**\n\nThanks for sharing the image. Our support team will review it and get back to you shortly.\n\n**Meanwhile**: ${getSmartReply(text)}`;
                }
            }

            if (lower.match(/(news|announcement|update|alert|notification)/)) {
                return latestAnnouncement;
            }

            if (lower.match(/^(hi|hello|hey|greetings|start|yo)/)) {
                const hour = new Date().getHours();
                const greeting = hour < 12 ? "Good Morning" : hour < 18 ? "Good Afternoon" : "Good Evening";
                chatContext = 'greeting';
                return `${greeting}, ${userName}! \n\nI am your **BATTLE-BOY Assistant**. I can help you with:\n\n **Latest News & Updates**\n **Wallet & Issues**\n **Room ID & Password**\n **Game Rules**\n\nHow may I assist you today?`;
            }

            if (lower.match(/(split|winning|deposit|bonus|how much.*withdraw)/)) {
                return ` **Wallet Breakdown**\n\n **Total:** ${totalBal.toFixed(2)}\n **Deposit:** ${depBal.toFixed(2)} (For playing)\n **Winnings:** <span style="color:#00E0FF; font-weight:bold;">${winBal.toFixed(2)}</span> (Withdrawable)`;
            }

            if (lower.match(/(balance|money|wallet|funds|amount)/)) {
                chatContext = 'wallet';
                return ` **Wallet Summary**\n\n**Current Balance:** <span style="color:#00E0FF; font-weight:bold;">${totalBal.toFixed(2)}</span>\n\nTo add funds, go to the **Wallet Tab** and click "Add Money".`;
            }

            if (lower.match(/(deposit|add|recharge|top up)/)) {
                chatContext = 'deposit';
                return ` **How to Deposit**\n\n1. Go to **Wallet**.\n2. Click **Add Money**.\n3. Enter amount (Min ${APP_INFO.minDeposit}).\n4. Pay via UPI.\n\nDid you face any issue with a recent deposit?`;
            }

            if (lower.match(/(withdraw|payout|cash out)/)) {
                chatContext = 'withdraw';
                return ` **Withdrawal Request**\n\n Minimum Withdrawal: **${APP_INFO.minWithdraw}**\n Processing Time: **${APP_INFO.withdrawTime}**\n Method: **UPI Only**\n\nPlease ensure your UPI ID is correct before submitting.`;
            }

            if (lower.match(/(room|id|pass|code|credential)/)) {
                chatContext = 'game';
                return ` **Room Access Info**\n\n **Room ID & Password** will appear in the **Match Details Page**.\n **Timing:** ${APP_INFO.roomTime}.\n **Requirement:** You must be joined in the match.\n\nPlease refresh the page at that time. Good luck! `;
            }

            if (lower.match(/(rule|hack|cheat|team|ban)/)) {
                return ` **Fair Play Policy**\n\nWe have a **Zero Tolerance Policy** for:\n\n Teaming up with enemies\n Using Hacks/Scripts\n Emulators\n\nViolators will be **banned permanently** and winnings frozen. Play fair, win fair! `;
            }

            if (lower.match(/(admin|human|talk|person|support|help)/)) {
                return ` **HSYT ESPORTS Support**\n\nI am an AI, but our team is ready to help.\n\n **Email:** [${APP_INFO.contactEmail}](mailto:${APP_INFO.contactEmail})\n **Telegram:** [${APP_INFO.contactTele}](https://t.me/${APP_INFO.contactTele.replace('@','')})\n\nResponse time: Under 2 hours.`;
            }

            if (lower.match(/(refer|invite|friend|code)/)) {
                return ` **Refer & Earn**\n\nYour Referral Code: **${refCode}**\n\nEarn bonus cash for every friend who joins and plays a match!`;
            }

            chatContext = 'unknown';
            return ` **I'm listening...**\n\nI didn't quite catch that, ${userName}.\n\n**Try asking:**\n "Any Announcements?"\n "Check my balance"\n "Deposit failed"\n "When do I get Room ID?"`;
        }

        async function sendUserMessage() { 
            const input = getElement('chatInput'); 
            const text = input.value.trim(); 
            
            if(!text && !selectedImageFile) return; 
            
            let imageUrl = null;
            if (selectedImageFile) {
                showLoader(true);
                try {
                    imageUrl = await uploadImageToStorage(selectedImageFile);
                } catch (error) {
                    showLoader(false);
                    addMessageToChat('bot', " Image upload failed. Please try again with a smaller image.");
                    resetImageUpload();
                    return;
                }
                showLoader(false);
            }
            
            let userMessage = text;
            if (imageUrl) {
                userMessage += ` [Image: ${imageUrl}]`;
                addMessageToChat('user', userMessage, imageUrl);
            } else {
                addMessageToChat('user', text); 
            }
            
            input.value = '';
            resetImageUpload();
            
            const chatBox = getElement('chatMessagesBox');
            const typingId = 'typing-' + Date.now();
            const typingHTML = `<div class="message-row bot animate-pop" id="${typingId}">
                <div class="chat-bot-avatar">
                    <img src="${APP_ICON_URL}" 
                         alt="App Icon" 
                         style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>
                <div class="chat-bubble bot" style="color: #A0A0B8; font-size: 0.85rem; padding: 10px 15px;">
                    <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true" style="width: 6px; height: 6px; animation-duration: 0.8s;"></span>
                    <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true" style="width: 6px; height: 6px; animation-duration: 0.8s; animation-delay: 0.2s;"></span>
                    <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true" style="width: 6px; height: 6px; animation-duration: 0.8s; animation-delay: 0.4s;"></span>
                    &nbsp; ${imageUrl ? "Analyzing image..." : "Thinking..."}
                </div>
            </div>`;
            
            chatBox.insertAdjacentHTML('beforeend', typingHTML);
            chatBox.scrollTop = chatBox.scrollHeight;

            setTimeout(() => { 
                const typingEl = document.getElementById(typingId);
                if(typingEl) typingEl.remove();

                const reply = getSmartReply(text, imageUrl);
                addMessageToChat('bot', reply); 
            }, 1500); 
        }

        function addMessageToChat(sender, text, imageUrl = null) { 
            const container = getElement('chatMessagesBox'); 
            const row = document.createElement('div'); 
            row.className = `message-row ${sender} animate-pop`; 
            
            let formattedText = text;
            
            if (imageUrl) {
                formattedText = formattedText.replace(/\[Image: .*?\]/, '');
            }
            
            formattedText = formattedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedText = formattedText.replace(/\[([^\]]+)\]\(([^)]+)\)/g, 
                '<a href="$2" target="_blank" style="color: #00E0FF; text-decoration: none; font-weight: 600; border-bottom: 1px dashed #00E0FF;">$1 <i class="fas fa-external-link-alt" style="font-size:0.75rem"></i></a>');
            formattedText = formattedText.replace(/\n/g, '<br>');
            formattedText = formattedText.replace(/(?<!href="|">)(https?:\/\/[^\s<]+)/g, 
                '<a href="$1" target="_blank" style="color: #00E0FF; text-decoration: underline;">$1</a>');

            const avatarHtml = (sender === 'bot') ? `
                <div class="chat-bot-avatar">
                    <img src="${APP_ICON_URL}" 
                         alt="App Icon" 
                         style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>` : '';
            
            let imageHtml = '';
            if (imageUrl && sender === 'user') {
                imageHtml = `<br><img src="${imageUrl}" class="chat-image-preview" style="cursor:pointer;" onclick="window.open('${imageUrl}', '_blank')">`;
            }
            
            row.innerHTML = `${avatarHtml}<div class="chat-bubble ${sender}">${formattedText}${imageHtml}</div>`; 
            
            container.appendChild(row); 
            container.scrollTop = container.scrollHeight; 
        }

        function resetImageUpload() {
            selectedImageFile = null;
            chatImagePreviewUrl = null;
            const imagePreview = getElement('chatImagePreview');
            const previewContainer = getElement('imagePreviewContainer');
            if (imagePreview) imagePreview.src = '';
            if (previewContainer) previewContainer.style.display = 'none';
            const imageInput = getElement('chatImageInput');
            if (imageInput) imageInput.value = '';
        }

        async function loadPrivacyPolicy() {
            const container = getElement('privacyPolicyContent');
            const loader = getElement('privacyContentLoader');
            if(!container) return;

            const defaultPrivacy = `
                <h2>Privacy Policy for BATTLE-BOY</h2>
                <p>Last Updated: ${new Date().toLocaleDateString()}</p>
                <h4>1. Introduction</h4>
                <p>Welcome to BATTLE-BOY! We are committed to protecting your privacy.</p>
                <h4>2. Information We Collect</h4>
                <ul><li>Personal Information</li><li>Transaction Data</li></ul>
            `;
            try {
                const snap = await get(ref(db, 'settings/privacyPolicy'));
                if(snap.exists() && snap.val()) { container.innerHTML = snap.val(); } else { container.innerHTML = defaultPrivacy; }
            } catch(e) { 
                console.error("Privacy policy load error:", e);
                container.innerHTML = defaultPrivacy; 
            } finally { 
                if(loader) loader.style.display = 'none'; 
                container.style.display = 'block'; 
            }
        }

        // Load recent notifications
        async function loadRecentNotifications() {
            const container = getElement('recentNotificationsList');
            if (!container) return;
            
            try {
                const snap = await get(ref(db, 'notifications'));
                
                if (!snap.exists()) {
                    container.innerHTML = '<div class="text-center text-secondary p-4">No notifications yet</div>';
                    return;
                }
                
                let notifications = [];
                snap.forEach(child => {
                    const notif = child.val();
                    notifications.push({
                        ...notif,
                        id: child.key,
                        date: notif.timestamp ? new Date(notif.timestamp).toLocaleDateString() : 'Recent'
                    });
                });
                
                // Sort by timestamp descending
                notifications.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Take only last 10
                notifications = notifications.slice(0, 10);
                
                if (notifications.length === 0) {
                    container.innerHTML = '<div class="text-center text-secondary p-4">No notifications yet</div>';
                    return;
                }
                
                let html = '';
                notifications.forEach(notif => {
                    const isForUser = notif.target === 'all' || 
                                     notif.target === currentUser.uid ||
                                     (notif.target === 'players' && userProfile.matchesPlayed > 0) ||
                                     (notif.specificUid === currentUser.uid);
                    
                    if (isForUser) {
                        html += `
                            <div class="notification-item p-3 border-bottom border-secondary" style="cursor:pointer;" onclick="showInAppNotification('${notif.title}', '${notif.body || notif.message}', '${notif.url || 'https://hsytesports.in'}')">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="fw-bold text-white">${notif.title}</div>
                                        <div class="text-secondary small mt-1">${notif.body || notif.message}</div>
                                    </div>
                                    <div class="text-end">
                                        <div class="text-muted small">${notif.date}</div>
                                        ${notif.isTest ? '<span class="badge bg-warning small">Test</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                if (html === '') {
                    html = '<div class="text-center text-secondary p-4">No notifications for you yet</div>';
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error("Error loading notifications:", error);
                container.innerHTML = '<div class="text-center text-danger p-4">Error loading notifications</div>';
            }
        }

        function showSection(sectionId, data = {}) {
            window.scrollTo(0, 0);
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const targetSection = getElement(sectionId);
            if(targetSection) {
                renderPageContent(sectionId, data);
                targetSection.classList.add('active');
                attachEventListenersForSection(sectionId, data);
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                if(item.dataset.section === sectionId) item.classList.add('active');
                else item.classList.remove('active');
            });
            const homeFab = getElement('navHomeFab');
            if (sectionId === 'home-section') homeFab.classList.add('active');
            else homeFab.classList.remove('active');

            const isHomePage = sectionId === 'home-section';
            const isMatchDetails = sectionId === 'match-details-section';

            getElement('app-header').style.display = isMatchDetails ? 'none' : 'flex';
            getElement('headerUserInfo').style.display = isHomePage ? 'flex' : 'none';
            getElement('headerBackBtn').style.display = isHomePage ? 'none' : 'block';
            getElement('headerPageTitle').style.display = isHomePage ? 'none' : 'block';
            
            const walletChip = getElement('headerWalletChip');
            if(walletChip) walletChip.style.display = isHomePage ? 'flex' : 'none';

            const hideNavPages = ['login-section', 'preparing-payment-section', 'payment-qr-section', 'ai-assistant-section', 'support-section', 'withdraw-section', 'privacy-policy-section', 'match-details-section', 'slot-selection-section', 'player-details-section', 'match-result-section', 'notifications-section'];
            const bottomNav = getElement('bottomNav');
            if(bottomNav) bottomNav.style.display = hideNavPages.includes(sectionId) ? 'none' : 'block';

            if (!isHomePage && !isMatchDetails) {
                let title = sectionId.replace('-section', '').replace(/^\w/, c => c.toUpperCase());
                if(sectionId === 'wallet-section') title = 'My Wallet';
                if(sectionId === 'add-money-section') title = 'Add Money';
                if(sectionId === 'withdraw-section') title = 'Withdraw Money';
                if(sectionId === 'preparing-payment-section') title = 'Preparing Payment';
                if(sectionId === 'payment-qr-section') title = 'Payment';
                if(sectionId === 'earn-section') title = 'My Referrals';
                if(sectionId === 'ai-assistant-section') title = 'AI Assistant';
                if(sectionId === 'support-section') title = 'Customer Support';
                if(sectionId === 'privacy-policy-section') title = 'Privacy Policy';
                if(sectionId === 'notifications-section') title = 'Notifications';
                
                if(sectionId === 'slot-selection-section') title = 'Choose Your Slot';
                if(sectionId === 'player-details-section') title = 'Enter Player Details';
                
                if(sectionId === 'tournaments-section') {
                    if (data.gameName) title = data.gameName;
                    else if (data.mode === 'my_matches') title = "My Contests";
                }
                
                getElement('headerPageTitle').textContent = title;
            }

            if(sectionId === 'profile-section') setTimeout(animateCounter, 100);
            
            if (sectionId === 'earn-section' && userProfile) {
                let code = userProfile.referralCode || (userProfile.displayName ? userProfile.displayName.substring(0,3).toUpperCase() + Math.floor(1000 + Math.random() * 9000) : "USER1234");
                if(getElement('myReferralCodeDisplay')) getElement('myReferralCodeDisplay').textContent = code;
                if(getElement('refCountVal')) getElement('refCountVal').textContent = userProfile.referralCount || 0;
                if(getElement('refEarningsVal')) getElement('refEarningsVal').textContent = "" + (userProfile.referralEarnings || 0);
            }

            if (sectionId === 'wallet-section') {
                loadWalletTransactions();
            }
            if (sectionId === 'history-section') {
                loadUserMatches('upcoming');
                
                const historyTabs = querySel('#history-section .tab-item');
                if(historyTabs) {
                    document.querySelectorAll('#history-section .tab-item').forEach(t => {
                        t.addEventListener('click', () => {
                            document.querySelectorAll('#history-section .tab-item').forEach(x => x.classList.remove('active'));
                            t.classList.add('active'); 
                            loadUserMatches(t.dataset.status);
                        });
                    });
                }
            }
            
            if (sectionId === 'home-section') {
                setTimeout(() => {
                    loadPromotions();
                }, 100);
            }
            
            if (sectionId === 'notifications-section') {
                resetNotificationCount();
                loadRecentNotifications();
            }
        }

        function attachEventListenersForSection(sectionId, data) {
            if (sectionId === 'home-section') { 
                setTimeout(() => {
                    loadPromotions(); 
                    loadGameCategories(); 
                    
                    document.querySelectorAll('.contest-categories .category-card').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const status = btn.dataset.statusTarget;
                            showSection('tournaments-section', { mode: 'my_matches', status: status });
                        });
                    });
                }, 50);
            }
            if (sectionId === 'login-section') {
                safeClick('loginEmailBtnEl', async () => { 
                    const e = getElement('loginEmailInputEl').value, p = getElement('loginPasswordInputEl').value; 
                    if(!e||!p) return showStatusMessage('loginStatusMessageEl', 'Fill fields'); 
                    showLoader(true); 
                    try { 
                        await signInWithEmailAndPassword(auth, e, p); 
                    } catch(x) { 
                        console.error("Login error:", x);
                        showStatusMessage('loginStatusMessageEl', x.message); 
                    } finally { 
                        showLoader(false); 
                    } 
                });
                safeClick('signupEmailBtnEl', async () => { 
                    const n = getElement('signupNameInputEl').value, e = getElement('signupEmailInputEl').value, p = getElement('signupPasswordInputEl').value; 
                    if(!n||!e||!p) return showStatusMessage('signupStatusMessageEl', 'Fill fields'); 
                    showLoader(true); 
                    try { 
                        const c = await createUserWithEmailAndPassword(auth, e, p); 
                        await set(ref(db, `users/${c.user.uid}`), { 
                            uid: c.user.uid, 
                            displayName: n, 
                            email: e, 
                            balance: 0, 
                            winningBalance: 0,
                            createdAt: serverTimestamp() 
                        }); 
                    } catch(x) { 
                        console.error("Signup error:", x);
                        showStatusMessage('signupStatusMessageEl', x.message); 
                    } finally { 
                        showLoader(false); 
                    } 
                });
                safeClick('showSignupToggleBtnEl', () => { 
                    getElement('emailLoginForm').style.display = 'none'; 
                    getElement('emailSignupForm').style.display = 'block'; 
                });
                safeClick('showLoginToggleBtnEl', () => { 
                    getElement('emailLoginForm').style.display = 'block'; 
                    getElement('emailSignupForm').style.display = 'none'; 
                });
            }
            if (sectionId === 'profile-section') {
                populateProfilePage(userProfile);
                safeClick('logoutBtn', () => { if(confirm('Logout?')) signOut(auth); });
                document.querySelectorAll('#profile-section .p-menu-item[data-section]').forEach(i => {
                    i.addEventListener('click', (e) => { 
                        e.preventDefault(); 
                        showSection(i.dataset.section); 
                    });
                });
            }
            if(sectionId === 'tournaments-section') {
                const isMyMatches = data.mode === 'my_matches';
                
                if(isMyMatches) getElement('headerPageTitle').innerText = "My Contests";
                else if(data.gameName) getElement('headerPageTitle').innerText = data.gameName;

                const initStatus = data.status || 'upcoming';
                
                document.querySelectorAll('#tournaments-section .tab-item').forEach(t => {
                    if(t.dataset.status === initStatus) t.classList.add('active');
                    else t.classList.remove('active');
                });

                if(isMyMatches) loadUserMatches(initStatus);
                else if (data.gameId) loadMatchesForCategory(data.gameId, initStatus, data);
                
                document.querySelectorAll('#tournaments-section .tab-item').forEach(t => {
                    t.addEventListener('click', () => {
                        document.querySelectorAll('#tournaments-section .tab-item').forEach(x => x.classList.remove('active'));
                        t.classList.add('active'); 
                        
                        const status = t.dataset.status;
                        if(isMyMatches) loadUserMatches(status);
                        else if (data.gameId) loadMatchesForCategory(data.gameId, status, data);
                    });
                });
            }
            if(sectionId === 'match-details-section') {
                safeClick('mdBackBtn', () => {
                    if (data.gameId) showSection('tournaments-section', { gameId: data.gameId, gameName: data.gameName, gameImage: data.gameImage });
                    else showSection('home-section');
                });

                const tabs = document.querySelectorAll('.md-tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.md-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content-area').forEach(c => c.classList.remove('active'));
                        
                        tab.classList.add('active');
                        
                        const targetId = `tab-${tab.getAttribute('data-tab')}`;
                        const targetContent = document.getElementById(targetId);
                        if(targetContent) targetContent.classList.add('active');
                    });
                });

                safeClick('mdJoinBtn', () => {
                    if(!userProfile) return alert("Please login first");
                    const fee = parseFloat(data.entryFee || 0);
                    if(userProfile.balance < fee) {
                        if(confirm("Insufficient Balance. Add Money?")) showSection('wallet-section');
                    } else {
                        showSection('slot-selection-section', data);
                    }
                });

                safeClick('btnViewResult', () => {
                    showSection('match-result-section', data);
                });

                // Room Details Button
                safeClick('btnShowRoomDetails', async () => {
                    try {
                        const matchRef = ref(db, `tournaments/${data.id}`);
                        const snap = await get(matchRef);
                        if (snap.exists()) {
                            const matchData = snap.val();
                            const modal = getElement('roomDetailsModal');
                            const roomIdEl = getElement('modalRoomId');
                            const roomPassEl = getElement('modalRoomPass');
                            
                            if (roomIdEl) roomIdEl.textContent = matchData.roomId || 'Not set';
                            if (roomPassEl) roomPassEl.textContent = matchData.roomPass || 'Not set';
                            
                            if (modal) modal.style.display = 'flex';
                        } else {
                            alert('Match data not found');
                        }
                    } catch (error) {
                        console.error('Error loading room details:', error);
                        alert('Error loading room details');
                    }
                });

                // Close Room Modal
                safeClick('closeRoomModal', () => {
                    const modal = getElement('roomDetailsModal');
                    if (modal) modal.style.display = 'none';
                });

                // Set up real-time listener for room details
                if (data.id) {
                    const matchRef = ref(db, `tournaments/${data.id}`);
                    dbListeners.matchDetails = onValue(matchRef, (snapshot) => {
                        const matchData = snapshot.val();
                        if (matchData) {
                            // Update room details in modal
                            const roomIdEl = getElement('modalRoomId');
                            const roomPassEl = getElement('modalRoomPass');
                            
                            if (roomIdEl) roomIdEl.textContent = matchData.roomId || 'Not set';
                            if (roomPassEl) roomPassEl.textContent = matchData.roomPass || 'Not set';
                        }
                    });
                }
            }

            if (sectionId === 'match-result-section') {
                safeClick('resBackBtn', () => {
                    showSection('match-details-section', data);
                });
                
                setTimeout(async () => {
                    const listEl = document.getElementById('realResultContainer');
                    if(!listEl) return;

                    try {
                        const snap = await get(ref(db, `tournaments/${data.id}/results`));
                        
                        if (snap.exists()) {
                            let resultsArray = [];
                            snap.forEach(child => {
                                resultsArray.push(child.val());
                            });

                            resultsArray.sort((a, b) => Number(a.rank) - Number(b.rank));
                            const limitedResults = resultsArray.slice(0, 48);

                            let rowsHtml = '';
                            limitedResults.forEach((r, i) => {
                                rowsHtml += `
                                    <div class="result-item-row animate-enter" style="animation-delay: ${i * 0.03}s">
                                        <div class="res-pos">${i+1}</div>
                                        <div class="res-name">${r.name}</div>
                                        <div class="res-rank-val">#${r.rank}</div>
                                        <div class="res-kill">${r.kills}</div>
                                        <div class="res-win">${Number(r.win).toFixed(2)}</div>
                                    </div>
                                `;
                            });
                            listEl.innerHTML = rowsHtml;
                        } else {
                            listEl.innerHTML = '<div class="text-center p-5 text-secondary">No results published yet.</div>';
                        }
                    } catch (e) {
                        console.error("Result Fetch Error:", e);
                        listEl.innerHTML = '<div class="text-center p-5 text-danger">Failed to load results.</div>';
                    }
                }, 100);
            }

            if(sectionId === 'slot-selection-section') {
                renderSlotSelection(data);
                
                safeClick('slotNextBtn', () => {
                    if(selectedSlots.length === 0) return alert("Please select at least one slot.");
                    const totalCost = selectedSlots.length * parseFloat(data.entryFee || 0);
                    if(userProfile.balance < totalCost) {
                        alert("Insufficient Balance for " + selectedSlots.length + " slots.");
                        return showSection('wallet-section');
                    }
                    
                    showSection('player-details-section', { ...data, selectedSlots: selectedSlots });
                });
            }
            if(sectionId === 'player-details-section') {
                renderPlayerDetails(data);
                
                safeClick('btnConfirmJoin', async () => {
                    const inputs = document.querySelectorAll('.details-input');
                    let isValid = true;
                    const participantsData = {}; 
                    
                    inputs.forEach(input => {
                        if(!input.value.trim()) isValid = false;
                        const slot = input.getAttribute('data-slot');
                        
                        if(!participantsData[slot]) participantsData[slot] = {};
                        participantsData[slot].ign = input.value.trim();
                    });
                    
                    if(!isValid) return alert("Please fill all details.");
                    
                    const totalCost = data.selectedSlots.length * parseFloat(data.entryFee || 0);
                    
                    showLoader(true);
                    try {
                        const userBalRef = ref(db, `users/${currentUser.uid}/balance`);
                        
                        const result = await runTransaction(userBalRef, (currentBal) => {
                            if (currentBal === null) return 0;
                            if (currentBal >= totalCost) {
                                return currentBal - totalCost;
                            } else {
                                return;
                            }
                        });

                        if (result.committed) {
                            await logTransaction(currentUser.uid, totalCost, 'debit', `Joined Match: Slot ${data.selectedSlots.join(',')}`);

                            const updates = {};
                            
                            data.selectedSlots.forEach(slot => {
                                updates[`tournaments/${data.id}/participants/${slot}`] = {
                                    userId: currentUser.uid,
                                    inGameName: participantsData[slot].ign,
                                    slot: parseInt(slot),
                                    joinedAt: serverTimestamp()
                                };
                            });

                            updates[`tournaments/${data.id}/filledSlots`] = (data.filledSlots || 0) + data.selectedSlots.length;
                            
                            updates[`users/${currentUser.uid}/matchesPlayed`] = (userProfile.matchesPlayed || 0) + 1;

                            await update(ref(db), updates);
                            
                            showLoader(false);
                            alert("Joined Successfully!");
                            showSection('history-section');
                        } else {
                            showLoader(false);
                            alert("Insufficient Balance or Transaction Failed.");
                        }
                        
                    } catch (e) {
                        console.error("Join match error:", e);
                        showLoader(false);
                        alert("Error joining match: " + e.message);
                    }
                });
            }
            if(sectionId === 'wallet-section') {
                safeClick('addMoneyBtn', () => showSection('add-money-section'));
                safeClick('withdrawBtn', () => showSection('withdraw-section'));
            }
            if(sectionId === 'add-money-section') {
                safeClick('proceedPayBtn', () => { 
                    const amount = getElement('addMoneyInput').value; 
                    if(amount >= 1 && amount <= 10000) startPaymentFlow(amount); 
                    else alert("Invalid Amount"); 
                });
            }
            if(sectionId === 'withdraw-section') {
                safeClick('submitWithdrawBtn', async () => { 
                    const amount = parseFloat(getElement('withdrawAmount').value);
                    const upi = getElement('withdrawUpi').value.trim();
                    
                    if(!amount || amount < 50) return alert("Min Withdrawal is 50"); 
                    if(!upi) return alert("Invalid UPI ID"); 
                    
                    showLoader(true);
                    try {
                        const userRef = ref(db, `users/${currentUser.uid}/balance`);
                        const result = await runTransaction(userRef, (currentBal) => {
                            if (currentBal === null) return 0; 
                            if (currentBal >= amount) {
                                return currentBal - amount;
                            } else {
                                return; 
                            }
                        });

                        if (result.committed) {
                            push(ref(db, 'withdrawals'), {
                                userId: currentUser.uid,
                                amount: amount,
                                upi: upi,
                                status: 'pending',
                                timestamp: serverTimestamp()
                            });
                            
                            await logTransaction(currentUser.uid, amount, 'debit', 'Withdrawal Request');

                            alert("Withdrawal Request Submitted!");
                            showSection('wallet-section');
                        } else {
                            alert("Insufficient Balance.");
                        }
                        showLoader(false);
                    } catch (err) {
                        console.error("Withdrawal error:", err);
                        alert("Error processing withdrawal.");
                        showLoader(false);
                    }
                });
            }
            if(sectionId === 'payment-qr-section') {
                safeClick('closeQrBtn', () => { 
                    if(confirm("Cancel?")) { 
                        if(paymentTimerInterval) clearInterval(paymentTimerInterval); 
                        showSection('wallet-section'); 
                    } 
                });
                
                safeClick('openVerifyBtn', () => {
                   const modal = getElement('paymentVerificationModal');
                   if(modal) modal.style.display = 'flex';
                });
                
                safeClick('cancelVerifyPayment', () => {
                   const modal = getElement('paymentVerificationModal');
                   if(modal) modal.style.display = 'none'; 
                });
                
                safeClick('submitVerifyPayment', async () => {
                   const upi = getElement('verifyUpiId').value.trim();
                   const utr = getElement('verifyUtr').value.trim();
                   const amountTxt = getElement('payOrderAmount').innerText.replace('', '');
                   const orderIdTxt = getElement('payOrderId').innerText;

                   if(!upi || utr.length < 8) {
                       alert("Please enter valid UPI ID and 12-digit UTR.");
                       return;
                   }
                   
                   showLoader(true);
                   try {
                       await push(ref(db, 'deposits'), {
                           userId: currentUser.uid,
                           upiId: upi,
                           utr: utr,
                           amount: amountTxt,
                           orderId: orderIdTxt,
                           status: 'pending',
                           timestamp: serverTimestamp()
                       });
                       
                       await logTransaction(currentUser.uid, amountTxt, 'credit', 'Deposit (Pending Verification)');
                       
                       alert("Verification Request Submitted! Please wait for approval.");
                       if(paymentTimerInterval) clearInterval(paymentTimerInterval);
                       showSection('wallet-section');
                   } catch(err) {
                       console.error("Payment verification error:", err);
                       alert("Error submitting verification. Try again.");
                   } finally {
                       showLoader(false);
                   }
                });
            }
            if(sectionId === 'earn-section') {
                safeClick('copyRefCodeBtn', () => { 
                    navigator.clipboard.writeText(getElement('myReferralCodeDisplay').innerText); 
                    alert("Copied"); 
                });
            }
            if(sectionId === 'ai-assistant-section') {
                safeClick('chatSendBtn', sendUserMessage);
                safeClick('chatImageBtn', () => {
                    getElement('chatImageInput').click();
                });
                
                safeClick('removeImageBtn', resetImageUpload);
                
                const input = getElement('chatInput');
                if(input) {
                    input.addEventListener('keypress', (e) => { 
                        if(e.key === 'Enter') sendUserMessage(); 
                    });
                }
                
                const imageInput = getElement('chatImageInput');
                if(imageInput) {
                    imageInput.addEventListener('change', function(e) {
                        if (this.files && this.files[0]) {
                            selectedImageFile = this.files[0];
                            
                            if (selectedImageFile.size > 5 * 1024 * 1024) {
                                alert("Image size should be less than 5MB");
                                resetImageUpload();
                                return;
                            }
                            
                            chatImagePreviewUrl = URL.createObjectURL(selectedImageFile);
                            const imagePreview = getElement('chatImagePreview');
                            const previewContainer = getElement('imagePreviewContainer');
                            
                            if (imagePreview && previewContainer) {
                                imagePreview.src = chatImagePreviewUrl;
                                previewContainer.style.display = 'block';
                            }
                        }
                    });
                }
            }
            if(sectionId === 'support-section') {
                safeClick('btnSupportWhatsapp', () => window.open(SUPPORT_LINKS.whatsapp, '_blank'));
                safeClick('btnSupportTelegram', () => window.open(SUPPORT_LINKS.telegram, '_blank'));
                safeClick('btnSupportInstagram', () => window.open(SUPPORT_LINKS.instagram, '_blank'));
                safeClick('btnSupportYoutube', () => window.open(SUPPORT_LINKS.youtube, '_blank'));
                safeClick('btnSupportEmail', () => window.open(`mailto:${SUPPORT_LINKS.email}`, '_blank'));
                safeClick('btnSupportWebsite', () => window.open(SUPPORT_LINKS.website, '_blank'));
            }
            if(sectionId === 'privacy-policy-section') {
                loadPrivacyPolicy();
            }
            if(sectionId === 'notifications-section') {
                // Update permission status
                document.getElementById('permissionStatus').textContent = Notification.permission;
                
                // Toggle switches
                document.getElementById('pushNotificationsToggle').addEventListener('change', async function() {
                    await update(ref(db, `users/${currentUser.uid}`), {
                        notificationEnabled: this.checked,
                        notificationUpdated: serverTimestamp()
                    });
                    
                    if (this.checked && Notification.permission === 'default') {
                        requestPermission();
                    }
                });
                
                document.getElementById('matchAlertsToggle').addEventListener('change', async function() {
                    await update(ref(db, `users/${currentUser.uid}`), {
                        notificationMatchAlerts: this.checked
                    });
                });
                
                document.getElementById('resultUpdatesToggle').addEventListener('change', async function() {
                    await update(ref(db, `users/${currentUser.uid}`), {
                        notificationResults: this.checked
                    });
                });
                
                document.getElementById('promoOffersToggle').addEventListener('change', async function() {
                    await update(ref(db, `users/${currentUser.uid}`), {
                        notificationPromo: this.checked
                    });
                });
                
                // Request permission button
                safeClick('requestPermissionBtn', requestPermission);
                
                async function requestPermission() {
                    try {
                        const permission = await Notification.requestPermission();
                        
                        document.getElementById('permissionStatus').textContent = permission;
                        
                        if (permission === 'granted') {
                            notificationPermission = true;
                            await getFCMToken();
                            alert('Notifications enabled successfully!');
                            
                            // Enable push notifications toggle
                            document.getElementById('pushNotificationsToggle').checked = true;
                            await update(ref(db, `users/${currentUser.uid}`), {
                                notificationEnabled: true,
                                notificationPermission: 'granted'
                            });
                        } else if (permission === 'denied') {
                            alert('Notifications blocked. Please enable them in your browser settings.');
                        }
                    } catch (error) {
                        console.error("Permission request error:", error);
                        alert('Error requesting notification permission.');
                    }
                }
            }
        }
        
        function showStatusMessage(id, msg) { 
            const el = getElement(id); 
            if(el) { 
                el.innerText = msg; 
                el.style.display = 'block'; 
                setTimeout(() => el.style.display='none', 3000); 
            } 
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if(!auth) {
                console.error("Auth not initialized");
                return;
            }
            showLoader(true);
            
            document.querySelectorAll('.nav-item').forEach(i => {
                i.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    showSection(i.dataset.section); 
                });
            });
            
            safeClick('navHomeFab', () => showSection('home-section'));
            
            safeClick('headerWalletChip', (e) => {
                e.preventDefault(); 
                showSection('wallet-section');
            });
            
            safeClick('headerBackBtn', () => {
                const currentSection = document.querySelector('.section.active').id;
                if(currentSection === 'add-money-section') showSection('wallet-section');
                else if(currentSection === 'withdraw-section') showSection('wallet-section');
                else if(currentSection === 'privacy-policy-section') showSection('profile-section');
                else if(currentSection === 'payment-qr-section') {
                     if(confirm("Cancel Payment?")) {
                        if(paymentTimerInterval) clearInterval(paymentTimerInterval);
                        showSection('wallet-section');
                    }
                }
                else if(currentSection === 'slot-selection-section') {
                    showSection('home-section'); 
                }
                else if(currentSection === 'player-details-section') {
                    showSection('home-section'); 
                }
                else if(currentSection === 'match-result-section') {
                    showSection('home-section'); 
                }
                else if(currentSection === 'notifications-section') {
                    showSection('profile-section');
                }
                else showSection('home-section');
            });
            
            await loadAppSettings(); 
            onAuthStateChanged(auth, handleAuthStateChange);
            
            // Load cached app icon
            const cachedIcon = localStorage.getItem('appIconUrl');
            if (cachedIcon && cachedIcon !== APP_ICON_URL) {
                updateAllAppIcons(cachedIcon);
            }
        });
    </script>
</body>
</html>